<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FB4747">
    <title data-i18n="pageTitle">إعدادات النظام | AndroGov</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brandRed: '#FB4747',
                        brandBlue: '#4267B2',
                        brandDark: '#1E293B',
                        brandGray: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'Inter', 'sans-serif'],
                        en: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;
        }
        .dark .loading-overlay { background: rgba(15, 23, 42, 0.9); }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 48px; height: 48px; border: 5px solid rgba(66, 103, 178, 0.1);
            border-top-color: #4267B2; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom File Input */
        .image-upload-wrapper:hover .upload-overlay { opacity: 1; }
        
        /* Color Picker Reset */
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 32px; height: 32px; border-radius: 50%; overflow: hidden; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
    </style>
</head>
<body class="bg-brandGray dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-sm font-bold text-slate-600 dark:text-slate-300">جاري تحميل الإعدادات...</p>
    </div>

    <div id="sidebar-container"></div>
    
    <div class="main-content-wrapper ltr:md:ml-72 rtl:md:mr-72 transition-all duration-300 flex flex-col min-h-screen">
        <div id="header-container"></div>

        <main class="p-6 space-y-6">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800 dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-brandRed"></i> <span data-i18n="pageTitle">إعدادات النظام</span>
                    </h1>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1" data-i18n="pageDesc">التحكم في الهوية، الاشتراكات، الأمان، والتفضيلات العامة.</p>
                </div>
                <button onclick="saveSettings()" class="px-6 py-2.5 bg-brandBlue text-white rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> <span data-i18n="btnSave">حفظ التغييرات</span>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="space-y-6">
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                        <h3 class="font-bold text-sm mb-6 flex items-center justify-center gap-2 text-slate-500">
                            <i class="fa-solid fa-palette"></i> الهوية البصرية
                        </h3>
                        
                        <div class="flex justify-center gap-8 mb-6">
                            <div class="relative image-upload-wrapper group w-24 h-24">
                                <img id="settingUserAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-slate-50 dark:border-slate-700 shadow-md">
                                <div class="upload-overlay absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition-opacity cursor-pointer">
                                    <i class="fa-solid fa-camera text-white"></i>
                                </div>
                                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewImage(this, 'settingUserAvatar')">
                                <p class="text-[10px] text-slate-400 mt-2">الصورة الشخصية</p>
                            </div>

                            <div class="relative image-upload-wrapper group w-24 h-24">
                                <img id="settingCompLogo" src="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" class="w-full h-full rounded-xl object-contain border-2 border-dashed border-slate-200 dark:border-slate-600 p-2 bg-white">
                                <div class="upload-overlay absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center opacity-0 transition-opacity cursor-pointer">
                                    <i class="fa-solid fa-cloud-arrow-up text-white"></i>
                                </div>
                                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewImage(this, 'settingCompLogo')">
                                <p class="text-[10px] text-slate-400 mt-2">شعار الشركة</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-left border-t border-slate-100 dark:border-slate-700 pt-4">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-bold text-slate-600 dark:text-slate-400">اللون الأساسي</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-mono text-slate-400">#FB4747</span>
                                    <input type="color" value="#FB4747" class="shadow-sm">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-bold text-slate-600 dark:text-slate-400">اللون الثانوي</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-mono text-slate-400">#4267B2</span>
                                    <input type="color" value="#4267B2" class="shadow-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-slate-700 dark:text-white border-b pb-2 dark:border-slate-700">
                            <i class="fa-solid fa-address-card text-brandBlue"></i> بيانات التواصل
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">البريد الإلكتروني (الأساسي)</label>
                                <input type="email" id="emailPrimary" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm outline-none focus:border-brandBlue font-mono text-slate-600 dark:text-white" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">البريد الاحتياطي (للاستعادة)</label>
                                <input type="email" id="emailBackup" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm outline-none focus:border-brandBlue font-mono placeholder:text-slate-300" placeholder="backup@example.com">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">رقم الجوال</label>
                                <div class="flex gap-2" dir="ltr">
                                    <input type="text" class="w-20 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm text-center font-mono" value="+966" readonly>
                                    <input type="text" class="flex-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm font-mono outline-none focus:border-brandBlue" placeholder="5xxxxxxxx">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="space-y-6">
                    
                    <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-crown text-9xl"></i></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs text-slate-400">الباقة الحالية</p>
                                    <h3 class="text-2xl font-bold text-white mt-1">Enterprise <span class="text-xs bg-brandRed px-2 py-0.5 rounded-full ml-2">Active</span></h3>
                                </div>
                                <button class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition">ترقية الباقة</button>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-slate-400">المستخدمين</span>
                                        <span class="font-mono">15 / 50</span>
                                    </div>
                                    <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                                        <div class="bg-brandBlue h-full w-[30%]"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-slate-400">مساحة التخزين</span>
                                        <span class="font-mono">45GB / 1TB</span>
                                    </div>
                                    <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                                        <div class="bg-green-500 h-full w-[5%]"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center text-xs border-t border-white/10 pt-4">
                                <span class="text-slate-400">تاريخ التجديد القادم:</span>
                                <span class="font-mono font-bold">01 Jan 2027</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-slate-700 dark:text-white border-b pb-2 dark:border-slate-700">
                            <i class="fa-solid fa-globe text-blue-500"></i> إعدادات النطاق (Domain)
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">النطاق المخصص</label>
                                <div class="flex gap-2">
                                    <input type="text" class="flex-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm outline-none focus:border-brandBlue font-mono text-left ltr" placeholder="portal.yourcompany.com" value="admin.ait.sa">
                                    <button class="px-4 bg-green-50 text-green-600 border border-green-200 rounded-lg text-xs font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-check-circle"></i> متصل
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">سجل CNAME يشير إلى: <code class="bg-slate-100 dark:bg-slate-900 px-1 rounded">lb.androgov.com</code></p>
                            </div>
                            
                            <div class="pt-2 border-t border-slate-100 dark:border-slate-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-bold text-slate-700 dark:text-white">وضع الصيانة</p>
                                        <p class="text-[10px] text-slate-500">إيقاف النظام مؤقتاً لجميع المستخدمين</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brandRed"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="space-y-6">
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-slate-700 dark:text-white border-b pb-2 dark:border-slate-700">
                            <i class="fa-solid fa-building text-slate-400"></i> تفاصيل المنشأة
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">اسم المنشأة</label>
                                <input type="text" id="compName" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm text-slate-600 dark:text-white font-bold" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">الرقم الموحد (700)</label>
                                <input type="text" id="compUnified" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm font-mono text-slate-600 dark:text-white" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">السجل التجاري</label>
                                <input type="text" id="compCR" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm font-mono text-slate-600 dark:text-white" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-slate-700 dark:text-white border-b pb-2 dark:border-slate-700">
                            <i class="fa-solid fa-shield-halved text-green-500"></i> الأمان
                        </h3>
                        
                        <form onsubmit="event.preventDefault(); alert('تم تحديث كلمة المرور');" class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">كلمة المرور الجديدة</label>
                                <input type="password" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm outline-none focus:border-brandBlue transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">تأكيد كلمة المرور</label>
                                <input type="password" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2.5 text-sm outline-none focus:border-brandBlue transition">
                            </div>
                            <button class="w-full py-2 bg-slate-800 hover:bg-black dark:hover:bg-slate-600 text-white rounded-lg text-xs font-bold transition">تحديث كلمة المرور</button>
                        </form>

                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold dark:text-white">المصادقة الثنائية (2FA)</p>
                                <p class="text-[9px] text-slate-400">SMS / Authenticator</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-slate-700 dark:text-white border-b pb-2 dark:border-slate-700">
                            <i class="fa-solid fa-gear text-slate-400"></i> التفضيلات
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-600 dark:text-slate-300">اللغة</span>
                                <select onchange="AppConfig.setLang(this.value); location.reload();" id="sysLang" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs px-2 py-1 outline-none">
                                    <option value="ar">العربية</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-600 dark:text-slate-300">المظهر</span>
                                <select onchange="AppConfig.setTheme(this.value)" id="sysTheme" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs px-2 py-1 outline-none">
                                    <option value="light">فاتح</option>
                                    <option value="dark">داكن</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <script src="data/company_policy.js"></script>
    <script src="js/core/config.js"></script>
    <script src="js/core/i18n.js"></script>
    <script src="js/helpers/policy-helpers.js"></script>
    <script src="js/services/data-service.js"></script>
    <script src="js/components/role-switcher.js"></script>
    <script src="js/components/layout.js"></script>
    <script src="js/components/bot.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkSystem = setInterval(() => {
                if (typeof Layout !== 'undefined' && typeof AppConfig !== 'undefined' && typeof DataService !== 'undefined') {
                    clearInterval(checkSystem);
                    
                    if (!AppConfig.getCurrentUser()) {
                        const defaultUser = DataService.getUserById('USR_004') || DataService.getUsers()[0];
                        if (defaultUser) {
                            AppConfig.setCurrentUser(defaultUser);
                        }
                    }

                    Layout.init();
                    document.getElementById('loadingOverlay')?.classList.add('hidden');
                    initPage();
                }
            }, 50);
        });

        function initPage() {
            const user = AppConfig.getCurrentUser();
            const company = DataService.getCompanyProfile();
            const lang = AppConfig.getLang();

            // 1. Fill Profile Data
            if(user) {
                // Ensure correct relative path for images
                let avatarPath = user.avatar || '';
                if(avatarPath && !avatarPath.startsWith('http') && !avatarPath.startsWith('../')) {
                     avatarPath = '../' + avatarPath;
                }
                document.getElementById('settingUserAvatar').src = avatarPath || 'https://ui-avatars.com/api/?name=User&background=random';
                document.getElementById('emailPrimary').value = user.email || '';
            }

            // 2. Fill Company Data
            if(company) {
                document.getElementById('compName').value = company.name || 'Andromeda IT';
                document.getElementById('compUnified').value = company.unifiedNumber || '7003339343';
                document.getElementById('compCR').value = company.crNumber || '1010356267';
            }

            // 3. Set Dropdowns
            document.getElementById('sysLang').value = lang;
            document.getElementById('sysTheme').value = AppConfig.getTheme();
        }

        function previewImage(input, targetId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(targetId).src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveSettings() {
            const lang = AppConfig.getLang();
            const msg = lang === 'ar' ? 'تم حفظ الإعدادات بنجاح!' : 'Settings saved successfully!';
            
            // Here you would typically save to backend
            // For now, we simulate saving to LocalStorage where applicable
            const newTheme = document.getElementById('sysTheme').value;
            AppConfig.setTheme(newTheme);

            alert(msg);
        }
    </script>
</body>
</html>
