<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FB4747">
    <meta name="description" content="AndroGov - User & Role Management System">
    <title>AndroGov | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brandRed: '#FB4747',
                        brandBlue: '#4267B2',
                        brandDark: '#1E293B',
                        brandGray: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'Inter', 'sans-serif'],
                        en: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- Page Styles -->
    <link rel="stylesheet" href="css/users.css">

    <style>
        /* Additional inline styles */
        body {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        body.loaded {
            opacity: 1;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .dark .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(66, 103, 178, 0.1);
            border-top-color: #4267B2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-brandGray dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-sm font-bold text-slate-600 dark:text-slate-300">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- ===== SIDEBAR CONTAINER ===== -->
    <div id="sidebar-container" class="no-print"></div>
    
    <!-- ===== MAIN CONTENT ===== -->
    <div class="main-content-wrapper ltr:md:ml-72 rtl:md:mr-72 transition-all duration-300 flex flex-col min-h-screen">
        
        <!-- Header Container -->
        <div id="header-container" class="no-print"></div>

        <!-- Page Content -->
        <main class="p-6 space-y-6">
            
            <!-- Page Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800 dark:text-white mb-1" data-i18n="users.pageTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h1>
                    <p class="text-sm text-slate-500 dark:text-slate-400" data-i18n="users.pageDesc">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø¨Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± (RBAC)</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="stats-container">
                <!-- Populated by JS -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
            </div>

            <!-- Main Workspace -->
            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 min-h-[600px] flex flex-col overflow-hidden">
                
                <!-- Toolbar -->
                <div class="p-4 md:p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-stretch md:items-center gap-4">
                    
                    <!-- View Tabs -->
                    <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                        <button 
                            onclick="UsersPage.switchView('users')" 
                            id="btn-users" 
                            class="flex-1 md:flex-none px-4 md:px-6 py-2 text-xs font-bold rounded-lg bg-white dark:bg-slate-600 text-brandBlue shadow-sm transition-all flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-users"></i>
                            <span data-i18n="users.directory">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                        </button>
                        <button 
                            onclick="UsersPage.switchView('roles')" 
                            id="btn-roles" 
                            class="flex-1 md:flex-none px-4 md:px-6 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-shield-halved"></i>
                            <span data-i18n="users.rolesStructure">Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                        </button>
                    </div>
                    
                    <!-- Search (Users View Only) -->
                    <div class="flex gap-3" id="userToolbar">
                        <div class="relative flex-1 md:w-72">
                            <input 
                                type="text" 
                                id="searchInput" 
                                onkeyup="UsersPage.search(this.value)"
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-brandBlue focus:border-transparent outline-none dark:text-white transition-all"
                                data-i18n-placeholder="users.searchPlaceholder"
                                placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¯ÙˆØ±ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..."
                            >
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <!-- View: Users List -->
                <div id="view-users" class="flex-1 fade-in">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase sticky top-0">
                                <tr>
                                    <th class="p-4 text-right" data-i18n="users.colUser">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="p-4 text-right" data-i18n="users.colRole">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                    <th class="p-4 text-right" data-i18n="users.colDept">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th class="p-4 text-right" data-i18n="users.colEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                    <th class="p-4 text-center" data-i18n="users.colStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="p-4 text-center" data-i18n="users.colActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700" id="usersTableBody">
                                <!-- Loading State -->
                                <tr>
                                    <td colspan="6" class="p-8 text-center">
                                        <div class="flex flex-col items-center gap-3 text-slate-400">
                                            <i class="fa-solid fa-spinner fa-spin text-3xl"></i>
                                            <p class="text-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View: Roles & Permissions -->
                <div id="view-roles" class="hidden flex-1 p-6 fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                        
                        <!-- Roles List -->
                        <div class="lg:col-span-4 lg:border-l border-slate-200 dark:border-slate-700 lg:pl-6 space-y-3 overflow-y-auto custom-scroll max-h-[550px]" id="rolesList">
                            <!-- Populated by JS -->
                            <div class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 animate-pulse">
                                <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                            </div>
                            <div class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 animate-pulse">
                                <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                            </div>
                        </div>
                        
                        <!-- Role Details & Permissions -->
                        <div class="lg:col-span-8">
                            <div class="bg-slate-50 dark:bg-slate-700/30 rounded-2xl p-6 border border-slate-200 dark:border-slate-600 h-full">
                                
                                <!-- Role Header -->
                                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6 pb-4 border-b border-slate-200 dark:border-slate-600">
                                    <div>
                                        <h3 class="font-bold text-xl text-slate-800 dark:text-white mb-1" id="roleDetailName">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                                        <p class="text-sm text-slate-500 dark:text-slate-400" id="roleDetailDesc">--</p>
                                    </div>
                                    <span id="roleInheritsBadge" class="hidden px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full text-xs font-bold whitespace-nowrap">
                                        <i class="fa-solid fa-link ml-1"></i>
                                        <span data-i18n="users.inheritsFrom">ÙŠØ±Ø« ØµÙ„Ø§Ø­ÙŠØ§Øª:</span>
                                        <span id="roleInheritsVal" class="font-bold"></span>
                                    </span>
                                </div>
                                
                                <!-- Permissions Grid -->
                                <div class="space-y-6 overflow-y-auto custom-scroll max-h-[400px] pr-2" id="permissionsContainer">
                                    <!-- Populated by JS -->
                                    <div class="text-center text-slate-400 py-8">
                                        <i class="fa-solid fa-shield-halved text-4xl mb-3"></i>
                                        <p class="text-sm">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="p-4 text-center text-xs text-slate-400 border-t border-slate-100 dark:border-slate-800">
            Â© 2026 Andromeda IT - AndroGov System v7.0
        </footer>
    </div>

    <!-- ===== SCRIPTS ===== -->
    
    <!-- 1. Data Layer -->
    <script src="data/company_policy.js"></script>
    
    <!-- 2. Core -->
    <script src="js/core/config.js"></script>
    <script src="js/core/i18n.js"></script>
    
    <!-- 3. Helpers (IMPORTANT: Load before services) -->
    <script src="js/helpers/policy-helpers.js"></script>
    
    <!-- 4. Services -->
    <script src="js/services/data-service.js"></script>
    
    <!-- 5. Components -->
    <script src="js/components/role-switcher.js"></script>
    <script src="js/components/layout.js"></script>
    <script src="js/components/bot.js"></script>
    
    <!-- 6. Page Controller -->
    <script src="js/pages/users-page.js"></script>

    <!-- 7. Page Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOM loaded, starting initialization...');
            
            // Wait for all dependencies to load
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max
            
            const checkDependencies = setInterval(() => {
                attempts++;
                
                const hasCompanyPolicy = typeof CompanyPolicy !== 'undefined';
                const hasPolicyHelpers = typeof PolicyHelpers !== 'undefined';
                const hasDataService = typeof DataService !== 'undefined';
                const hasAppConfig = typeof AppConfig !== 'undefined';
                const hasI18n = typeof I18n !== 'undefined';
                const hasLayout = typeof Layout !== 'undefined';
                const hasUsersPage = typeof UsersPage !== 'undefined';
                
                console.log(`ğŸ“Š Dependency check (${attempts}/${maxAttempts}):`, {
                    CompanyPolicy: hasCompanyPolicy,
                    PolicyHelpers: hasPolicyHelpers,
                    DataService: hasDataService,
                    AppConfig: hasAppConfig,
                    I18n: hasI18n,
                    Layout: hasLayout,
                    UsersPage: hasUsersPage
                });
                
                if (hasCompanyPolicy && hasPolicyHelpers && hasDataService && 
                    hasAppConfig && hasI18n && hasLayout && hasUsersPage) {
                    
                    clearInterval(checkDependencies);
                    console.log('âœ… All dependencies loaded successfully!');
                    
                    // Hide loading overlay
                    document.getElementById('loadingOverlay')?.classList.add('hidden');
                    
                    // Initialize page
                    setTimeout(() => {
    try {
        // --- Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ± ---
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ØŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if (!AppConfig.getCurrentUser() && typeof DataService !== 'undefined') {
            console.log('âš ï¸ No user logged in. Auto-logging as Admin...');
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ (Ù…Ø«Ù„Ø§Ù‹ USR_004 Ø£ÙŠÙ…Ù† Ø§Ù„Ù…ØºØ±Ø¨ÙŠ Ø£Ùˆ USR_001 Ù‡Ø´Ø§Ù…)
            const defaultUser = DataService.getUserById('USR_004') || DataService.getUsers()[0];
            if (defaultUser) {
                AppConfig.setCurrentUser(defaultUser);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ "Ø§Ù„Ù‡ÙŠØ¯Ø±"
                location.reload();
                return; 
            }
        }
                        try {
                            console.log('ğŸ¯ Initializing UsersPage...');
                            UsersPage.init();
                            console.log('âœ… UsersPage initialized successfully!');
                        } catch (error) {
                            console.error('âŒ Error initializing UsersPage:', error);
                            showErrorMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                        }
                    }, 100);
                    
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkDependencies);
                    console.error('âŒ Timeout: Dependencies not loaded after 5 seconds');
                    
                    // Show which dependencies failed
                    const missing = [];
                    if (!hasCompanyPolicy) missing.push('CompanyPolicy');
                    if (!hasPolicyHelpers) missing.push('PolicyHelpers');
                    if (!hasDataService) missing.push('DataService');
                    if (!hasAppConfig) missing.push('AppConfig');
                    if (!hasI18n) missing.push('I18n');
                    if (!hasLayout) missing.push('Layout');
                    if (!hasUsersPage) missing.push('UsersPage');
                    
                    console.error('âŒ Missing dependencies:', missing);
                    showErrorMessage(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${missing.join(', ')}<br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©.`);
                }
            }, 100);
        });
        
        function showErrorMessage(message) {
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            
            const tbody = document.getElementById('usersTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-8 text-center">
                            <div class="flex flex-col items-center gap-3 text-red-500">
                                <i class="fa-solid fa-exclamation-triangle text-4xl"></i>
                                <p class="text-sm font-bold">${message}</p>
                                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-brandRed text-white rounded-lg text-sm font-bold hover:bg-red-700 transition">
                                    <i class="fa-solid fa-rotate-right ml-2"></i>
                                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„',
                    html: message,
                    confirmButtonText: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„',
                    confirmButtonColor: '#FB4747',
                    customClass: {
                        popup: 'dark:bg-slate-800 dark:text-white'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload();
                    }
                });
            }
        }
    </script>

</body>
</html>
