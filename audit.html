<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AndroGov | Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brandRed: '#FB4747',
            brandDark: '#1E293B',
            brandGray: '#F1F5F9',
          },
          fontFamily: { sans: ['Tajawal', 'Inter', 'sans-serif'] }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    .dark ::-webkit-scrollbar-thumb { background-color: #475569; }

    .fade-in { animation: fadeIn 0.22s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .sidebar-overlay { background: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 40; display: none; }
    .sidebar-overlay.active { display: block; }

    .notification-pulse { animation: pulse-red 2s infinite; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(251, 71, 71, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(251, 71, 71, 0); }
      100% { box-shadow: 0 0 0 0 rgba(251, 71, 71, 0); }
    }
    /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¥Ø°Ø§ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Tailwind */
.hidden { display: none !important; }

/* Ø§Ø­ØªÙŠØ§Ø·: Ø£ÙŠ Ø·Ø¨Ù‚Ø© overlay Ù„Ø§ ØªÙƒÙˆÙ† Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¶ØºØ· ÙˆÙ‡ÙŠ Ù…Ø®ÙÙŠØ© */
#modal, #modalBackdrop, #aiPanel, #notifDropdown {
  pointer-events: none;
}
#modal.active, #modalBackdrop.active, #aiPanel.active, #notifDropdown:not(.hidden) {
  pointer-events: auto;
}
    @media (max-width: 768px) {
      #sidebar { position: fixed; right: 0; top: 0; height: 100%; transform: translateX(100%); transition: transform 0.3s; z-index: 50; }
      #sidebar.open { transform: translateX(0); }
      html[dir="ltr"] #sidebar { left: 0; right: auto; transform: translateX(-100%); }
      html[dir="ltr"] #sidebar.open { transform: translateX(0); }
    }

    .chat-bubble { max-width: 85%; padding: 10px 12px; border-radius: 14px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4; }
    .chat-ai { background-color: #FB4747; color: white; border-bottom-left-radius: 4px; }
    .chat-user { background-color: #f1f5f9; color: #1e293b; border-bottom-right-radius: 4px; }
    .dark .chat-user { background-color: #334155; color: white; }

    #aiSidebar {
      position: fixed;
      top: 0;
      height: 100%;
      width: 100%;
      max-width: 24rem;
      z-index: 60;
      transform: translateX(120%);
      transition: transform 0.3s;
    }
    @media (max-width: 768px) { #aiSidebar { max-width: 100%; } }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 70; display: none; }
    .modal-overlay.active { display: block; }
    .modal { position: fixed; inset: 0; z-index: 80; display: none; align-items: center; justify-content: center; padding: 16px; }
    .modal.active { display: flex; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-white h-screen overflow-hidden flex font-sans transition-colors duration-300">

  <div id="mobileOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
  <div id="toastContainer" class="fixed top-4 z-[90] flex flex-col gap-2" style="right:16px;"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-white dark:bg-slate-800 border-l dark:border-slate-700 flex flex-col shadow-xl shrink-0 h-full">
    <div class="h-20 flex items-center px-6 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 shrink-0">
      <img src="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" class="w-10 h-10 rounded-lg bg-white p-0.5 shadow-sm shrink-0" alt="Andromeda Logo">
      <div class="mr-3">
        <h1 class="font-bold text-lg text-brandRed">AndroGov</h1>
        <p class="text-[10px] text-slate-400 font-bold tracking-wider" data-i18n="sidebar_subtitle">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</p>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button onclick="renderView('dashboard')" class="w-full flex items-center gap-4 px-4 py-3 bg-brandRed text-white rounded-xl shadow-lg font-bold transition nav-item" id="nav-dashboard">
        <i class="fa-solid fa-gauge-high w-5 text-center"></i> <span data-i18n="overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span>
      </button>
      <button onclick="renderView('missions')" class="w-full flex items-center gap-4 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition nav-item" id="nav-missions">
        <i class="fa-solid fa-list-check w-5 text-center"></i> <span data-i18n="missions">Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</span>
      </button>
      <button onclick="renderView('findings')" class="w-full flex items-center gap-4 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition nav-item" id="nav-findings">
        <i class="fa-solid fa-bug w-5 text-center"></i> <span data-i18n="findings">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
      </button>
      <button onclick="renderView('reports')" class="w-full flex items-center gap-4 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition nav-item" id="nav-reports">
        <i class="fa-solid fa-file-contract w-5 text-center"></i> <span data-i18n="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©</span>
      </button>

      <div class="my-4 border-t border-slate-100 dark:border-slate-700">
        <p class="text-[10px] text-slate-400 font-bold uppercase mt-4 mb-2 px-2" data-i18n="self_service">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°Ø§ØªÙŠØ©</p>
      </div>

      <button onclick="renderView('profile')" class="w-full flex items-center gap-4 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition nav-item" id="nav-profile">
        <i class="fa-solid fa-id-card w-5 text-center"></i> <span data-i18n="profile_hr">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (HR)</span>
      </button>
    </nav>

    <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition shrink-0" onclick="logout()">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-10 h-10 rounded-full bg-brandRed text-white flex items-center justify-center font-bold text-sm shadow-sm border-2 border-white dark:border-slate-700">IA</div>
          <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-slate-700 rounded-full"></span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold truncate text-slate-800 dark:text-white" data-i18n="user_name">Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</p>
          <p class="text-[10px] text-slate-500 truncate" data-i18n="user_role">Internal Auditor</p>
        </div>
        <i class="fa-solid fa-right-from-bracket text-red-500 text-sm" title="Logout"></i>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-white dark:bg-slate-900">
    <header class="h-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 md:px-8 shrink-0 z-10 sticky top-0">
      <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="md:hidden text-slate-600 dark:text-white p-2" aria-label="Open menu">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <div>
          <h2 class="text-xl font-bold text-slate-800 dark:text-white" id="pageTitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Andromeda Audit System v2.1 (Demo)</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <!-- Notifications -->
        <div class="relative" id="notifWrap">
          <button onclick="toggleNotifications()" class="relative w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition" aria-label="Notifications">
            <i class="fa-regular fa-bell"></i>
            <span id="notifDot" class="absolute top-0 right-0 w-3 h-3 bg-brandRed border-2 border-white dark:border-slate-900 rounded-full notification-pulse"></span>
          </button>

          <div id="notifDropdown" class="absolute top-12 left-0 w-80 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden z-50 overflow-hidden">
            <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
              <h4 class="font-bold text-sm text-slate-800 dark:text-white" data-i18n="notif_title">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h4>
              <button class="text-xs text-brandRed hover:underline" onclick="markAllRead()" data-i18n="read_all">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button>
            </div>
            <div class="max-h-64 overflow-y-auto" id="notifList"></div>
          </div>
        </div>

        <!-- AI -->
        <button onclick="toggleAI(true)" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-brandRed flex items-center justify-center hover:bg-red-50 dark:hover:bg-slate-700 transition" aria-label="AI Consultant">
          <i class="fa-solid fa-robot text-lg"></i>
        </button>

        <!-- Language -->
        <button onclick="toggleLanguage()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition font-bold text-xs" id="langLabel">EN</button>

        <!-- Theme -->
        <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition" aria-label="Toggle theme">
          <i id="themeIcon" class="fa-solid fa-moon"></i>
        </button>
      </div>
    </header>

    <div id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 dark:bg-slate-900"></div>
  </main>

  <!-- AI Sidebar -->
  <aside id="aiSidebar" class="bg-white dark:bg-slate-800 shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col">
    <div class="h-20 flex items-center justify-between px-6 bg-brandRed text-white shrink-0">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-clipboard-check text-xl"></i>
        <div>
          <h3 class="font-bold text-sm" data-i18n="ai_title">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ</h3>
          <p class="text-[10px] text-red-100" id="aiPowered">Powered by Demo AI</p>
        </div>
      </div>
      <button onclick="toggleAI(false)" class="text-white/80 hover:text-white transition" aria-label="Close AI">
        <i class="fa-solid fa-xmark text-lg"></i>
      </button>
    </div>

    <div id="chatArea" class="flex-1 bg-slate-50 dark:bg-slate-900 p-4 overflow-y-auto flex flex-col"></div>

    <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shrink-0">
      <div class="flex gap-2 relative">
        <input id="aiInput" type="text" placeholder="..." class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brandRed dark:text-white transition-all"
          onkeydown="if(event.key === 'Enter') sendAIMessage()">
        <button onclick="sendAIMessage()" class="bg-brandRed hover:bg-red-600 text-white w-12 rounded-xl transition-colors flex items-center justify-center shadow-lg shadow-red-500/30" aria-label="Send">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
      <p class="text-[10px] text-slate-400 mt-2" id="aiHint">Enter Ù„Ø¥Ø±Ø³Ø§Ù„ â€¢ Esc Ù„Ù„Ø¥ØºÙ„Ø§Ù‚</p>
    </div>
  </aside>

  <!-- Modal Overlay -->
  <div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
      <div class="p-4 md:p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-slate-50 dark:bg-slate-900">
        <h3 class="font-bold text-slate-800 dark:text-white" id="modalTitle">Modal</h3>
        <button class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition flex items-center justify-center"
          onclick="closeModal()" aria-label="Close modal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-4 md:p-6" id="modalBody"></div>
      <div class="p-4 md:p-5 border-t border-slate-100 dark:border-slate-700 flex items-center justify-end gap-2 bg-slate-50 dark:bg-slate-900" id="modalFooter"></div>
    </div>
  </div>

  <script>
    // =========================
    // i18n
    // =========================
    const translations = {
      ar: {
        sidebar_subtitle: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ",
        overview: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©",
        missions: "Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        findings: "Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        self_service: "Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°Ø§ØªÙŠØ©",
        profile_hr: "Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (HR)",
        user_name: "Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
        user_role: "Ù…Ø¯Ù‚Ù‚ Ø¯Ø§Ø®Ù„ÙŠ",

        notif_title: "Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",
        read_all: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„",

        ai_title: "Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ",
        ai_welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹\nØ£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø¯ÙŠÙ…Ùˆ Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ. Ø§ÙƒØªØ¨: (Ù…Ù„Ø§Ø­Ø¸Ø©) Ø£Ùˆ (Ø®Ø·Ø©) Ø£Ùˆ (ØªÙ‚Ø±ÙŠØ±) ÙˆØ³Ø£Ù‚ØªØ±Ø­ Ù„Ùƒ Ø®Ø·ÙˆØ§Øª Ø¬Ø§Ù‡Ø²Ø©.",

        plan_progress: "Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©",
        open_findings: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø©",
        urgent_actions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ø§Ø¬Ù„Ø©",
        audit_coverage: "ØªØºØ·ÙŠØ© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        audit_status: "Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        completed: "Ù…ÙƒØªÙ…Ù„",
        in_progress: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
        planned: "Ù…Ø®Ø·Ø·",
        quick_actions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
        new_mission: "Ù…Ù‡Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯Ø©",
        add_finding: "ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©",
        generate_report: "Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ±",

        audit_missions: "Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        search: "Ø¨Ø­Ø«",
        filter_status: "ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø©",
        all: "Ø§Ù„ÙƒÙ„",
        status_planned: "Ù…Ø®Ø·Ø·",
        status_ongoing: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
        status_done: "Ù…ÙƒØªÙ…Ù„",
        col_mission: "Ø§Ù„Ù…Ù‡Ù…Ø©",
        col_dept: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
        col_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
        col_due: "Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
        col_actions: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
        btn_details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„",

        findings_log: "Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª",
        col_ref: "Ø§Ù„Ù…Ø±Ø¬Ø¹",
        col_desc: "Ø§Ù„ÙˆØµÙ",
        col_risk: "Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©",
        col_owner: "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
        col_state: "Ø§Ù„Ø­Ø§Ù„Ø©",
        risk_low: "Ù…Ù†Ø®ÙØ¶Ø©",
        risk_med: "Ù…ØªÙˆØ³Ø·Ø©",
        risk_high: "Ø¹Ø§Ù„ÙŠØ©",
        state_open: "Ù…ÙØªÙˆØ­Ø©",
        state_progress: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
        state_closed: "Ù…Ù‚ÙÙ„Ø©",

        audit_reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        btn_download: "ØªØ­Ù…ÙŠÙ„ PDF",
        btn_generate: "ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±",
        rep_summary: "ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø±Ù‚Ø§Ø¨ÙŠ",
        rep_followup: "ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        rep_missions: "ØªÙ‚Ø±ÙŠØ± Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",

        full_name: "Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
        full_role: "Ù…Ø±Ø§Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ Ø£ÙˆÙ„",
        on_job: "Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…Ù„",
        leave_bal: "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª",
        days_25: "22 ÙŠÙˆÙ…",
        commit_score: "Ù…Ø¤Ø´Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…",
        btn_checkin: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±",
        btn_leave: "Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©",
        btn_salary: "ØªØ¹Ø±ÙŠÙ Ø±Ø§ØªØ¨",
        btn_support: "Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        attend_log: "Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø¢Ø®Ø± 3 Ø£ÙŠØ§Ù…)",

        save: "Ø­ÙØ¸",
        cancel: "Ø¥Ù„ØºØ§Ø¡",
        close: "Ø¥ØºÙ„Ø§Ù‚",
        confirm: "ØªØ£ÙƒÙŠØ¯",
        edit: "ØªØ¹Ø¯ÙŠÙ„",
        delete: "Ø­Ø°Ù",
        export_pdf: "ØªØµØ¯ÙŠØ± PDF"
      },
      en: {
        sidebar_subtitle: "Internal Audit Portal",
        overview: "Overview",
        missions: "Audit Missions",
        findings: "Findings Log",
        reports: "Audit Reports",
        self_service: "Self Service",
        profile_hr: "My Profile (HR)",
        user_name: "Ali Alghamdi",
        user_role: "Internal Auditor",

        notif_title: "Notifications",
        read_all: "Read All",

        ai_title: "Audit Consultant",
        ai_welcome: "Hello ğŸ‘‹\nIâ€™m a demo audit assistant. Type: (finding) or (plan) or (report) and Iâ€™ll propose ready steps.",

        plan_progress: "Annual Plan Progress",
        open_findings: "Open Findings",
        urgent_actions: "Urgent Actions",
        audit_coverage: "Audit Coverage",
        audit_status: "Audit Tasks Status",
        completed: "Completed",
        in_progress: "In Progress",
        planned: "Planned",
        quick_actions: "Quick Actions",
        new_mission: "New Audit Mission",
        add_finding: "Log Finding",
        generate_report: "Generate Report",

        audit_missions: "Audit Missions",
        search: "Search",
        filter_status: "Status Filter",
        all: "All",
        status_planned: "Planned",
        status_ongoing: "Ongoing",
        status_done: "Completed",
        col_mission: "Mission",
        col_dept: "Department",
        col_status: "Status",
        col_due: "Due",
        col_actions: "Actions",
        btn_details: "Details",

        findings_log: "Findings & Violations Log",
        col_ref: "Ref",
        col_desc: "Description",
        col_risk: "Risk",
        col_owner: "Owner",
        col_state: "State",
        risk_low: "Low",
        risk_med: "Medium",
        risk_high: "High",
        state_open: "Open",
        state_progress: "In Progress",
        state_closed: "Closed",

        audit_reports: "Audit Reports",
        btn_download: "Download PDF",
        btn_generate: "Generate",
        rep_summary: "Audit Summary Report",
        rep_followup: "Follow-up Report",
        rep_missions: "Missions Report",

        full_name: "Ali Abdullah Alghamdi",
        full_role: "Senior Internal Auditor",
        on_job: "Active",
        leave_bal: "Leave Balance",
        days_25: "22 Days",
        commit_score: "Commitment Score",
        btn_checkin: "Check In/Out",
        btn_leave: "Request Leave",
        btn_salary: "Salary Certificate",
        btn_support: "Support",
        attend_log: "Attendance Log (3 Days)",

        save: "Save",
        cancel: "Cancel",
        close: "Close",
        confirm: "Confirm",
        edit: "Edit",
        delete: "Delete",
        export_pdf: "Export PDF"
      }
    };

    let currentLang = localStorage.getItem('lang') || 'ar';
    let currentView = 'dashboard';
    let auditChart = null;

    const STORE_KEY = "AndroGovDemoStore_v1";

    function todayISO() {
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function seedStore() {
      return {
        notifications: [
          { id: "n1", title_ar: "Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", title_en: "Finance Dept Response", meta_ar: "Ù…Ù†Ø° Ø³Ø§Ø¹Ø© â€¢ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ", meta_en: "1h ago â€¢ CFO", read: false },
          { id: "n2", title_ar: "Ù…ÙˆØ¹Ø¯ ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©", title_en: "HR Audit Scheduled", meta_ar: "ØºØ¯Ø§Ù‹ 9:00 Øµ â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯", meta_en: "Tomorrow 9:00 AM â€¢ HR Dept", read: false }
        ],
        missions: [
          {
            id: "M-2025-001",
            title_ar: "ØªØ¯Ù‚ÙŠÙ‚ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«",
            title_en: "Q3 Procurement Audit",
            dept_ar: "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª",
            dept_en: "Procurement",
            status: "ongoing",
            due: "2025-11-20",
            scope_ar: "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹ÙŠÙ‘Ù†Ø© Ù…Ù† Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª.",
            scope_en: "Review a sample of POs, match invoices, and verify approvals.",
            objective_ar: "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª ÙˆØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ²Ø§Øª.",
            objective_en: "Ensure policy compliance and reduce overrun risks.",
            owner_ar: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
            owner_en: "Finance",
            progress: 55,
            createdAt: "2025-10-01"
          },
          {
            id: "M-2025-002",
            title_ar: "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø±ÙˆØ§ØªØ¨ Ø£ÙƒØªÙˆØ¨Ø±",
            title_en: "Oct Payroll Review",
            dept_ar: "Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©",
            dept_en: "HR",
            status: "planned",
            due: "2025-11-25",
            scope_ar: "Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø¯Ù„Ø§ØªØŒ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª.",
            scope_en: "Validate allowances, working hours, and deduction approvals.",
            objective_ar: "Ø¶Ø¨Ø· Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØªÙ‚Ù„ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµØ±Ù.",
            objective_en: "Improve payroll accuracy and reduce disbursement errors.",
            owner_ar: "Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©",
            owner_en: "HR",
            progress: 0,
            createdAt: "2025-10-10"
          },
          {
            id: "M-2025-003",
            title_ar: "ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ",
            title_en: "Cybersecurity Audit",
            dept_ar: "Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            dept_en: "Tech",
            status: "done",
            due: "2025-10-30",
            scope_ar: "ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØŒ ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø«.",
            scope_en: "Assess access controls, backups, and incident response.",
            objective_ar: "ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©.",
            objective_en: "Strengthen controls and reduce operational risks.",
            owner_ar: "ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
            owner_en: "IT",
            progress: 100,
            createdAt: "2025-09-01"
          }
        ],
        findings: [
          {
            id: "F-2025-01",
            ref: "F-2025-01",
            desc_ar: "Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¯ÙØ§ØªØ±.",
            desc_en: "Fixed asset balances mismatch between register and books.",
            risk: "high",
            owner_ar: "Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
            owner_en: "Finance",
            state: "open",
            relatedMissionId: "M-2025-001",
            recommendation_ar: "ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙˆÙ„ ÙˆØ¥Ø¬Ø±Ø§Ø¡ ØªØ³ÙˆÙŠØ© Ø´Ù‡Ø±ÙŠØ© Ù…Ø¹ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©.",
            recommendation_en: "Update FA register and perform monthly reconciliation with Finance approval.",
            managementResponse_ar: "Ø³ÙŠØªÙ… Ø­ØµØ± Ø§Ù„Ø£ØµÙˆÙ„ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† ÙˆØ¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª.",
            managementResponse_en: "Assets will be inventoried within 2 weeks and variances closed.",
            due: "2025-12-05",
            createdAt: "2025-10-15"
          },
          {
            id: "F-2025-02",
            ref: "F-2025-02",
            desc_ar: "ØªØ£Ø®Ø± ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø±Ø®Øµ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ (Ø®Ø·Ø± ØªÙˆÙ‚Ù Ø§Ù„Ø®Ø¯Ù…Ø©).",
            desc_en: "Delay renewing software licenses (service downtime risk).",
            risk: "med",
            owner_ar: "Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            owner_en: "Tech",
            state: "progress",
            relatedMissionId: "M-2025-003",
            recommendation_ar: "Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø¬Ù„ Ø±Ø®Øµ ÙˆØ±Ø¨Ø· ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ 60 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.",
            recommendation_en: "Maintain license register and set reminders 60 days before expiry.",
            managementResponse_ar: "ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙƒØªÙ…Ù„ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù….",
            managementResponse_en: "Update started and will complete within 7 days.",
            due: "2025-11-10",
            createdAt: "2025-10-20"
          }
        ],
        profile: {
          employeeId: "2020",
          name_ar: "Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
          name_en: "Ali Abdullah Alghamdi",
          role_ar: "Ù…Ø±Ø§Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ Ø£ÙˆÙ„",
          role_en: "Senior Internal Auditor",
          leaveBalance: 22,
          commitment: 99,
          attendance: [
            { date_ar: "Ø§Ù„Ø£Ø­Ø¯ØŒ 12 Ø£ÙƒØªÙˆØ¨Ø±", date_en: "Sun, 12 Oct", in_ar: "07:45 Øµ", out_ar: "04:00 Ù…", in_en: "07:45 AM", out_en: "04:00 PM", status_ar: "Ù…ÙƒØªÙ…Ù„", status_en: "Complete" },
            { date_ar: "Ø§Ù„Ø®Ù…ÙŠØ³ØŒ 09 Ø£ÙƒØªÙˆØ¨Ø±", date_en: "Thu, 09 Oct", in_ar: "07:50 Øµ", out_ar: "04:10 Ù…", in_en: "07:50 AM", out_en: "04:10 PM", status_ar: "Ù…ÙƒØªÙ…Ù„", status_en: "Complete" },
            { date_ar: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ØŒ 08 Ø£ÙƒØªÙˆØ¨Ø±", date_en: "Wed, 08 Oct", in_ar: "08:00 Øµ", out_ar: "04:00 Ù…", in_en: "08:00 AM", out_en: "04:00 PM", status_ar: "ÙÙŠ Ø§Ù„ÙˆÙ‚Øª", status_en: "On Time" }
          ],
          lastCheck: null
        }
      };
    }

    function getStore() {
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) {
        const seeded = seedStore();
        localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
        return seeded;
      }
      try { return JSON.parse(raw); } catch {
        const seeded = seedStore();
        localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
        return seeded;
      }
    }

    function setStore(next) { localStorage.setItem(STORE_KEY, JSON.stringify(next)); }

    function updateStore(mutator) {
      const s = getStore();
      const next = mutator(structuredClone(s)) || s;
      setStore(next);
      return next;
    }

    function t(key) { return translations[currentLang][key] || key; }
    function isDark() { return document.documentElement.classList.contains('dark'); }
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function statusLabel(status) {
      if (status === 'planned') return t('status_planned');
      if (status === 'ongoing') return t('status_ongoing');
      if (status === 'done') return t('status_done');
      return status;
    }

    function statusBadge(status) {
      const map = {
        planned: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200',
        ongoing: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200',
        done: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200'
      };
      const cls = map[status] || 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-200';
      return `<span class="px-2 py-1 rounded text-xs font-bold ${cls}">${statusLabel(status)}</span>`;
    }

    function riskBadge(risk) {
      const map = {
        low:  { cls:'text-green-600', label: t('risk_low') },
        med:  { cls:'text-yellow-500', label: t('risk_med') },
        high: { cls:'text-red-500', label: t('risk_high') }
      };
      const x = map[risk] || { cls:'text-slate-500', label:risk };
      return `<span class="${x.cls} font-bold text-xs">${x.label}</span>`;
    }

    function stateBadge(state) {
      const map = {
        open:     { cls:'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-200', label: t('state_open') },
        progress: { cls:'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200', label: t('state_progress') },
        closed:   { cls:'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200', label: t('state_closed') }
      };
      const x = map[state] || { cls:'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-200', label: state };
      return `<span class="px-2 py-1 rounded text-xs font-bold ${x.cls}">${x.label}</span>`;
    }

    function toast(message, type='info') {
      const wrap = document.getElementById('toastContainer');
      if (document.documentElement.dir === 'rtl') {
        wrap.style.right = '16px'; wrap.style.left = 'auto';
      } else {
        wrap.style.left = '16px'; wrap.style.right = 'auto';
      }

      const colors = {
        info: 'border-slate-200 dark:border-slate-700',
        success: 'border-green-200 dark:border-green-900/40',
        warning: 'border-yellow-200 dark:border-yellow-900/40',
        danger: 'border-red-200 dark:border-red-900/40'
      };

      const icon = {
        info: 'fa-circle-info',
        success: 'fa-circle-check',
        warning: 'fa-triangle-exclamation',
        danger: 'fa-circle-xmark'
      }[type] || 'fa-circle-info';

      const el = document.createElement('div');
      el.className = `fade-in bg-white dark:bg-slate-800 border ${colors[type]} shadow-xl rounded-xl px-4 py-3 flex items-start gap-3 max-w-sm`;
      el.innerHTML = `
        <i class="fa-solid ${icon} text-brandRed mt-0.5"></i>
        <div class="text-sm text-slate-700 dark:text-slate-200">${escapeHtml(message)}</div>
      `;
      wrap.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; }, 2600);
      setTimeout(() => { el.remove(); }, 3000);
    }

    // =========================
    // Modal
    // =========================
    function openModal(title, bodyHTML, footerHTML) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalBody').innerHTML = bodyHTML;
      document.getElementById('modalFooter').innerHTML = footerHTML || '';
      document.getElementById('modalOverlay').classList.add('active');
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.getElementById('modal').classList.remove('active');
      document.getElementById('modalBody').innerHTML = '';
      document.getElementById('modalFooter').innerHTML = '';
    }

    // =========================
    // Notifications
    // =========================
    function renderNotifications() {
      const s = getStore();
      const list = document.getElementById('notifList');
      const items = s.notifications;

      list.innerHTML = items.map(n => {
        const title = currentLang === 'ar' ? n.title_ar : n.title_en;
        const meta = currentLang === 'ar' ? n.meta_ar : n.meta_en;
        const unread = !n.read;
        return `
          <div class="p-3 border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ${unread ? '' : 'opacity-70'}"
               onclick="markNotifRead('${n.id}')">
            <div class="flex items-center justify-between gap-2">
              <p class="text-xs font-bold text-slate-700 dark:text-slate-200">${escapeHtml(title)}</p>
              ${unread ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-brandRed text-white">NEW</span>' : ''}
            </div>
            <p class="text-[10px] text-slate-400 mt-1">${escapeHtml(meta)}</p>
          </div>
        `;
      }).join('');

      const hasUnread = items.some(x => !x.read);
      document.getElementById('notifDot').style.display = hasUnread ? 'block' : 'none';
    }

    function toggleNotifications() {
      const dd = document.getElementById('notifDropdown');
      dd.classList.toggle('hidden');
    }

    function markNotifRead(id) {
      updateStore(s => {
        const n = s.notifications.find(x => x.id === id);
        if (n) n.read = true;
        return s;
      });
      renderNotifications();
      toast(currentLang === 'ar' ? 'ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.' : 'Notification opened.', 'info');
      document.getElementById('notifDropdown').classList.add('hidden');
    }

    function markAllRead() {
      updateStore(s => { s.notifications.forEach(n => n.read = true); return s; });
      renderNotifications();
      toast(currentLang === 'ar' ? 'ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡.' : 'All marked as read.', 'success');
      document.getElementById('notifDropdown').classList.add('hidden');
    }

    // =========================
    // Sidebar / Theme / Language
    // =========================
    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const ov = document.getElementById('mobileOverlay');
      sb.classList.toggle('open');
      ov.classList.toggle('active');
    }

    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      const dark = isDark();
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      document.getElementById('themeIcon').className = dark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      if (currentView === 'dashboard') setTimeout(initChart, 30);
      toast(dark ? (currentLang==='ar'?'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†.':'Dark mode enabled.')
                 : (currentLang==='ar'?'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­.':'Light mode enabled.'), 'info');
    }

    function toggleLanguage() {
      currentLang = (currentLang === 'ar') ? 'en' : 'ar';
      localStorage.setItem('lang', currentLang);
      applyLanguage();
      renderView(currentView);
      renderNotifications();
      initChat();
      if (currentView === 'dashboard') setTimeout(initChart, 30);
      positionAI();
      toast(currentLang === 'ar' ? 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.' : 'Language switched to English.', 'success');
    }

    function applyLanguage() {
      const html = document.documentElement;
      html.setAttribute('lang', currentLang);
      html.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');
      document.getElementById('langLabel').innerText = currentLang === 'ar' ? 'EN' : 'AR';

      const dd = document.getElementById('notifDropdown');
      dd.style.left = (currentLang === 'ar') ? '0' : 'auto';
      dd.style.right = (currentLang === 'ar') ? 'auto' : '0';

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) el.innerText = translations[currentLang][key];
      });
    }

    // =========================
    // AI
    // =========================
    let aiOpen = false;

    function positionAI() {
      const ai = document.getElementById('aiSidebar');
      if (currentLang === 'ar') {
        ai.style.left = '0';
        ai.style.right = 'auto';
        ai.style.transform = aiOpen ? 'translateX(0)' : 'translateX(-120%)';
      } else {
        ai.style.right = '0';
        ai.style.left = 'auto';
        ai.style.transform = aiOpen ? 'translateX(0)' : 'translateX(120%)';
      }
    }

    function toggleAI(open) {
      aiOpen = open;
      positionAI();
      if (aiOpen) setTimeout(() => document.getElementById('aiInput')?.focus(), 50);
    }

    function initChat() {
      const chat = document.getElementById('chatArea');
      const welcome = translations[currentLang].ai_welcome;
      const align = (currentLang === 'ar') ? 'justify-end' : 'justify-start';
      chat.innerHTML = `
        <div class="flex ${align} fade-in">
          <div class="chat-bubble chat-ai whitespace-pre-line">${escapeHtml(welcome)}</div>
        </div>
      `;
    }

    function sendAIMessage() {
      const input = document.getElementById('aiInput');
      const msg = input.value.trim();
      if (!msg) return;

      const chat = document.getElementById('chatArea');
      const userAlign = (currentLang === 'ar') ? 'justify-start' : 'justify-end';
      chat.innerHTML += `<div class="flex ${userAlign} fade-in"><div class="chat-bubble chat-user">${escapeHtml(msg)}</div></div>`;
      input.value = '';
      chat.scrollTop = chat.scrollHeight;

      const aiAlign = (currentLang === 'ar') ? 'justify-end' : 'justify-start';
      const typingId = 'typing-' + Date.now();
      setTimeout(() => {
        chat.innerHTML += `<div id="${typingId}" class="flex ${aiAlign} fade-in"><div class="chat-bubble chat-ai">â€¦</div></div>`;
        chat.scrollTop = chat.scrollHeight;
      }, 200);

      setTimeout(() => {
        const node = document.getElementById(typingId);
        if (!node) return;

        const lower = msg.toLowerCase();
        let reply = (currentLang==='ar')
          ? "ØªÙ…. ØªØ¨ÙŠ ØªØ³ÙˆÙŠ: 1) ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© 2) Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© 3) ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±ØŸ"
          : "Got it. Do you want: 1) log a finding 2) add a mission 3) generate a report?";

        if (lower.includes('Ù…Ù„Ø§Ø­Ø¸Ø©') || lower.includes('finding')) {
          reply = currentLang==='ar' ? "Ù…Ù…ØªØ§Ø². Ø§ÙØªØ­ Ù„Ùƒ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ" : "Great. Want me to open the Log Finding form?";
        }
        if (lower.includes('Ù…Ù‡Ù…Ø©') || lower.includes('mission')) {
          reply = currentLang==='ar' ? "ØªÙ…Ø§Ù…. ØªØ¨ÙŠ Ù†Ø¶ÙŠÙ Ù…Ù‡Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ†Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ØŸ" : "Sure. Shall we add a new mission with department and due date?";
        }
        if (lower.includes('ØªÙ‚Ø±ÙŠØ±') || lower.includes('report')) {
          reply = currentLang==='ar' ? "Ø£Ù‚Ø¯Ø± Ø£Ø·Ù„Ø¹ Ù„Ùƒ ØªÙ‚Ø±ÙŠØ± PDF (Ù…Ù„Ø®Øµ/Ù…ØªØ§Ø¨Ø¹Ø©/Ù…Ù‡Ø§Ù…). ØªØ¨ÙŠ Ø£ÙŠ ÙˆØ§Ø­Ø¯ØŸ" : "I can generate a PDF (summary/follow-up/missions). Which one?";
        }

        node.innerHTML = `<div class="chat-bubble chat-ai">${escapeHtml(reply)}</div>`;
        chat.scrollTop = chat.scrollHeight;
      }, 700);
    }

    // =========================
    // Views Rendering
    // =========================
    function renderView(view) {
      currentView = view;

      document.querySelectorAll('.nav-item').forEach(el => {
        el.className = `w-full flex items-center gap-4 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition nav-item`;
      });
      const active = document.getElementById('nav-' + view);
      if (active) active.className = `w-full flex items-center gap-4 px-4 py-3 bg-brandRed text-white rounded-xl shadow-lg font-bold transition nav-item`;

      const pageTitle = document.getElementById('pageTitle');
      const content = document.getElementById('mainContent');

      if (view === 'dashboard') {
        pageTitle.innerText = t('overview');
        content.innerHTML = dashboardHTML();
        setTimeout(initChart, 40);
      } else if (view === 'missions') {
        pageTitle.innerText = t('missions');
        content.innerHTML = missionsHTML();
        setTimeout(renderMissionsTable, 0);
      } else if (view === 'findings') {
        pageTitle.innerText = t('findings');
        content.innerHTML = findingsHTML();
        setTimeout(renderFindingsTable, 0);
      } else if (view === 'reports') {
        pageTitle.innerText = t('reports');
        content.innerHTML = reportsHTML();
      } else if (view === 'profile') {
        pageTitle.innerText = t('profile_hr');
        content.innerHTML = profileHTML();
      }

      if (window.innerWidth < 768) {
        const sb = document.getElementById('sidebar');
        if (sb.classList.contains('open')) toggleSidebar();
      }
    }

    // =========================
    // Dashboard
    // =========================
    function dashboardHTML() {
      const s = getStore();
      const openFindings = s.findings.filter(f => f.state !== 'closed').length;
      const urgentActions = s.findings.filter(f => f.risk === 'high' && f.state !== 'closed').length;
      const plannedOrOngoing = s.missions.filter(m => m.status !== 'done').length;
      const completed = s.missions.filter(m => m.status === 'done').length;
      const total = Math.max(1, s.missions.length);
      const progress = Math.round((completed / total) * 100);
      const coverage = Math.min(95, Math.max(60, Math.round((total / 10) * 100)));

      return `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
          ${statCard(t('plan_progress'), progress + '%', 'green')}
          ${statCard(t('open_findings'), String(openFindings), 'red')}
          ${statCard(t('urgent_actions'), String(urgentActions), 'orange')}
          ${statCard(t('audit_coverage'), coverage + '%', 'blue')}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
          <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-brandRed"></i> ${t('audit_status')}
              </h3>
              <div class="flex gap-2">
                <button class="px-3 py-2 text-xs font-bold rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition"
                        onclick="openGenerateReport('summary')">
                  <i class="fa-solid fa-file-export"></i> ${t('export_pdf')}
                </button>
              </div>
            </div>
            <div class="relative h-64 w-full">
              <canvas id="auditChartCanvas"></canvas>
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
            <h3 class="font-bold text-slate-800 dark:text-white mb-4">${t('quick_actions')}</h3>
            <div class="space-y-3">
              ${quickActionBtn(t('new_mission'), 'fa-plus', "openNewMission()")}
              ${quickActionBtn(t('add_finding'), 'fa-pen-to-square', "openNewFinding()")}
              ${quickActionBtn(t('generate_report'), 'fa-file-lines', "renderView('reports')")}
            </div>

            <div class="mt-6 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <p class="text-xs font-bold text-slate-700 dark:text-slate-200 mb-2">${currentLang==='ar'?'Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©':'Quick Indicators'}</p>
              <div class="text-xs text-slate-500 dark:text-slate-300 space-y-1">
                <div>â€¢ ${currentLang==='ar'?'Ù…Ù‡Ø§Ù… ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©':'Open missions'}: <b class="text-slate-700 dark:text-white">${plannedOrOngoing}</b></div>
                <div>â€¢ ${currentLang==='ar'?'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±':'High risk findings'}: <b class="text-slate-700 dark:text-white">${urgentActions}</b></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function statCard(label, value, tint) {
      const bg = {
        green: 'bg-green-50 dark:bg-green-900/20',
        red: 'bg-red-50 dark:bg-red-900/20',
        orange: 'bg-orange-50 dark:bg-orange-900/20',
        blue: 'bg-blue-50 dark:bg-blue-900/20'
      }[tint] || 'bg-slate-50 dark:bg-slate-800';

      const val = {
        green: 'text-green-600',
        red: 'text-red-500',
        orange: 'text-brandRed',
        blue: 'text-blue-600'
      }[tint] || 'text-slate-700';

      return `
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden">
          <div class="absolute right-0 top-0 w-20 h-20 ${bg} rounded-bl-full"></div>
          <p class="text-slate-500 dark:text-slate-400 text-xs font-bold mb-1 relative z-10">${escapeHtml(label)}</p>
          <h3 class="text-3xl font-extrabold ${val} relative z-10">${escapeHtml(value)}</h3>
        </div>
      `;
    }

    function quickActionBtn(label, icon, action) {
      return `
        <button class="w-full text-start p-3 bg-slate-50 dark:bg-slate-700/50 hover:bg-red-50 dark:hover:bg-slate-700 rounded-lg transition group"
                onclick="${action}">
          <div class="flex items-center gap-2">
            <i class="fa-solid ${icon} text-slate-400 group-hover:text-brandRed"></i>
            <p class="text-xs font-bold text-slate-700 dark:text-slate-200 group-hover:text-brandRed">${escapeHtml(label)}</p>
          </div>
        </button>
      `;
    }

    function initChart() {
      const canvas = document.getElementById('auditChartCanvas');
      if (!canvas) return;

      const s = getStore();
      const done = s.missions.filter(m => m.status === 'done').length;
      const ongoing = s.missions.filter(m => m.status === 'ongoing').length;
      const planned = s.missions.filter(m => m.status === 'planned').length;

      if (auditChart) auditChart.destroy();
      const legendColor = isDark() ? '#E2E8F0' : '#334155';

      auditChart = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: [t('completed'), t('in_progress'), t('planned')],
          datasets: [{
            data: [done, ongoing, planned],
            backgroundColor: ['#10B981', '#3B82F6', '#FB4747'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: legendColor } }
          }
        }
      });
    }

    // =========================
    // Missions
    // =========================
    function missionsHTML() {
      return `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-5">
            <div>
              <h3 class="font-bold text-lg text-slate-800 dark:text-white">${t('audit_missions')}</h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${currentLang==='ar'?'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø« (Demo)':'Manage missions with search & filter (Demo)'}</p>
            </div>
            <div class="flex gap-2">
              <button class="bg-brandRed text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-red-600 transition" onclick="openNewMission()">
                <i class="fa-solid fa-plus"></i> ${t('new_mission')}
              </button>
              <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="openGenerateReport('missions')">
                <i class="fa-solid fa-file-export"></i> ${t('export_pdf')}
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <div class="md:col-span-2">
              <label class="text-xs text-slate-500 dark:text-slate-400">${t('search')}</label>
              <div class="mt-1 flex items-center gap-2 bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3">
                <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                <input id="missionSearch" class="w-full bg-transparent py-3 text-sm outline-none" placeholder="${currentLang==='ar'?'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…':'Search by title, dept, or id'}"
                  oninput="renderMissionsTable()">
              </div>
            </div>
            <div>
              <label class="text-xs text-slate-500 dark:text-slate-400">${t('filter_status')}</label>
              <select id="missionStatusFilter" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                onchange="renderMissionsTable()">
                <option value="all">${t('all')}</option>
                <option value="planned">${t('status_planned')}</option>
                <option value="ongoing">${t('status_ongoing')}</option>
                <option value="done">${t('status_done')}</option>
              </select>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-start text-sm text-slate-600 dark:text-slate-300">
              <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">
                <tr>
                  <th class="p-4">${t('col_mission')}</th>
                  <th class="p-4">${t('col_dept')}</th>
                  <th class="p-4">${t('col_status')}</th>
                  <th class="p-4">${t('col_due')}</th>
                  <th class="p-4">${t('col_actions')}</th>
                </tr>
              </thead>
              <tbody id="missionsTbody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderMissionsTable() {
      const s = getStore();
      const tbody = document.getElementById('missionsTbody');
      if (!tbody) return;

      const q = (document.getElementById('missionSearch')?.value || '').trim().toLowerCase();
      const st = document.getElementById('missionStatusFilter')?.value || 'all';

      const filtered = s.missions.filter(m => {
        const title = (currentLang==='ar'?m.title_ar:m.title_en).toLowerCase();
        const dept  = (currentLang==='ar'?m.dept_ar:m.dept_en).toLowerCase();
        const hit = title.includes(q) || dept.includes(q) || m.id.toLowerCase().includes(q);
        const okStatus = (st==='all') ? true : m.status===st;
        return hit && okStatus;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-sm text-slate-500">${currentLang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.':'No results found.'}</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(m => {
        const title = currentLang==='ar'?m.title_ar:m.title_en;
        const dept  = currentLang==='ar'?m.dept_ar:m.dept_en;
        return `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
            <td class="p-4">
              <div class="font-bold text-slate-800 dark:text-white">${escapeHtml(title)}</div>
              <div class="text-[11px] text-slate-400 font-mono mt-1">${escapeHtml(m.id)}</div>
            </td>
            <td class="p-4">${escapeHtml(dept)}</td>
            <td class="p-4">${statusBadge(m.status)}</td>
            <td class="p-4">${escapeHtml(m.due)}</td>
            <td class="p-4">
              <div class="flex items-center gap-2">
                <button class="text-xs text-brandRed font-bold hover:underline" onclick="openMissionDetails('${m.id}')">${t('btn_details')}</button>
                <span class="text-slate-300">â€¢</span>
                <button class="text-xs text-slate-500 font-bold hover:underline" onclick="openEditMission('${m.id}')">${t('edit')}</button>
                <span class="text-slate-300">â€¢</span>
                <button class="text-xs text-red-500 font-bold hover:underline" onclick="confirmDeleteMission('${m.id}')">${t('delete')}</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openMissionDetails(id) {
      const s = getStore();
      const m = s.missions.find(x => x.id === id);
      if (!m) return;

      const title = currentLang==='ar'?m.title_ar:m.title_en;
      const dept  = currentLang==='ar'?m.dept_ar:m.dept_en;
      const scope = currentLang==='ar'?m.scope_ar:m.scope_en;
      const obj   = currentLang==='ar'?m.objective_ar:m.objective_en;
      const owner = currentLang==='ar'?m.owner_ar:m.owner_en;

      const relatedFindings = s.findings.filter(f => f.relatedMissionId === id);

      const body = `
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø©':'Mission ID'}</div>
              <div class="font-mono text-sm font-bold text-slate-800 dark:text-white">${escapeHtml(m.id)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'Status'}</div>
              <div class="mt-1">${statusBadge(m.status)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Department'}</div>
              <div class="text-sm font-bold text-slate-800 dark:text-white">${escapeHtml(dept)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚':'Due date'}</div>
              <div class="text-sm font-bold text-slate-800 dark:text-white">${escapeHtml(m.due)}</div>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
            <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†':'Title'}</div>
            <div class="text-lg font-extrabold text-slate-800 dark:text-white mt-1">${escapeHtml(title)}</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„Ù‡Ø¯Ù':'Objective'}</div>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${escapeHtml(obj)}</p>
              </div>
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„':'Owner'}</div>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${escapeHtml(owner)}</p>
              </div>
            </div>
            <div class="mt-4">
              <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚':'Scope'}</div>
              <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${escapeHtml(scope)}</p>
            </div>

            <div class="mt-4">
              <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„ØªÙ‚Ø¯Ù…':'Progress'}</div>
              <div class="mt-2 w-full h-3 rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden">
                <div class="h-3 bg-brandRed rounded-full" style="width:${m.progress || 0}%"></div>
              </div>
              <div class="text-xs text-slate-500 mt-1">${m.progress || 0}%</div>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
            <div class="flex items-center justify-between">
              <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©':'Related Findings'}</div>
              <button class="text-xs font-bold text-brandRed hover:underline" onclick="openNewFinding('${m.id}')">
                <i class="fa-solid fa-plus"></i> ${t('add_finding')}
              </button>
            </div>
            <div class="mt-3 space-y-2">
              ${relatedFindings.length ? relatedFindings.map(f => `
                <div class="p-3 rounded-lg bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 flex items-center justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-[11px] font-mono text-slate-400">${escapeHtml(f.ref)}</div>
                    <div class="text-sm font-bold text-slate-800 dark:text-white truncate">${escapeHtml(currentLang==='ar'?f.desc_ar:f.desc_en)}</div>
                    <div class="mt-1 flex items-center gap-2">
                      ${riskBadge(f.risk)}
                      <span class="text-slate-300">â€¢</span>
                      ${stateBadge(f.state)}
                    </div>
                  </div>
                  <button class="text-xs text-brandRed font-bold hover:underline shrink-0" onclick="openFindingDetails('${f.id}')">${t('btn_details')}</button>
                </div>
              `).join('') : `<div class="text-sm text-slate-500">${currentLang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©.':'No related findings.'}</div>`}
            </div>
          </div>
        </div>
      `;

      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">
          ${t('close')}
        </button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="openEditMission('${m.id}')">
          <i class="fa-solid fa-pen"></i> ${t('edit')}
        </button>
      `;

      openModal(currentLang==='ar'?'ØªÙØ§ØµÙŠÙ„ Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚':'Mission Details', body, footer);
    }

    function openNewMission() {
      const body = missionFormHTML({ mode:'new' });
      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="saveMission('new')">
          <i class="fa-solid fa-check"></i> ${t('save')}
        </button>
      `;
      openModal(currentLang==='ar'?'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚':'Add New Mission', body, footer);
    }

    function openEditMission(id) {
      const s = getStore();
      const m = s.missions.find(x => x.id === id);
      if (!m) return;
      const body = missionFormHTML({ mode:'edit', mission: m });
      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="saveMission('edit','${m.id}')">
          <i class="fa-solid fa-check"></i> ${t('save')}
        </button>
      `;
      openModal(currentLang==='ar'?'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…Ø©':'Edit Mission', body, footer);
    }

    function missionFormHTML({mode, mission}) {
      const m = mission || {
        id: '',
        title_ar: '',
        title_en: '',
        dept_ar: '',
        dept_en: '',
        status: 'planned',
        due: todayISO(),
        scope_ar: '',
        scope_en: '',
        objective_ar: '',
        objective_en: '',
        owner_ar: '',
        owner_en: '',
        progress: 0
      };

      const idField = (mode === 'edit')
        ? `<div class="text-xs text-slate-500">${currentLang==='ar'?'Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø©':'Mission ID'}: <span class="font-mono font-bold">${escapeHtml(m.id)}</span></div>`
        : '';

      return `
        <div class="space-y-4">
          ${idField}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ)':'Title (AR)'}</label>
              <input id="m_title_ar" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.title_ar)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (EN)':'Title (EN)'}</label>
              <input id="m_title_en" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.title_en)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¹Ø±Ø¨ÙŠ)':'Department (AR)'}</label>
              <input id="m_dept_ar" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.dept_ar)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (EN)':'Department (EN)'}</label>
              <input id="m_dept_en" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.dept_en)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'Status'}</label>
              <select id="m_status" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">
                <option value="planned" ${m.status==='planned'?'selected':''}>${t('status_planned')}</option>
                <option value="ongoing" ${m.status==='ongoing'?'selected':''}>${t('status_ongoing')}</option>
                <option value="done" ${m.status==='done'?'selected':''}>${t('status_done')}</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚':'Due date'}</label>
              <input id="m_due" type="date" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.due)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø¹Ø±Ø¨ÙŠ)':'Owner (AR)'}</label>
              <input id="m_owner_ar" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.owner_ar)}" />
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (EN)':'Owner (EN)'}</label>
              <input id="m_owner_en" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(m.owner_en)}" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù‡Ø¯Ù (Ø¹Ø±Ø¨ÙŠ)':'Objective (AR)'}</label>
              <textarea id="m_obj_ar" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(m.objective_ar)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù‡Ø¯Ù (EN)':'Objective (EN)'}</label>
              <textarea id="m_obj_en" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(m.objective_en)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù†Ø·Ø§Ù‚ (Ø¹Ø±Ø¨ÙŠ)':'Scope (AR)'}</label>
              <textarea id="m_scope_ar" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(m.scope_ar)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù†Ø·Ø§Ù‚ (EN)':'Scope (EN)'}</label>
              <textarea id="m_scope_en" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(m.scope_en)}</textarea>
            </div>
          </div>

          <div>
            <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ØªÙ‚Ø¯Ù… (%)':'Progress (%)'}</label>
            <input id="m_progress" type="number" min="0" max="100" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
              value="${escapeHtml(m.progress ?? 0)}" />
          </div>
        </div>
      `;
    }

    function saveMission(mode, id) {
      const title_ar = document.getElementById('m_title_ar')?.value.trim();
      const title_en = document.getElementById('m_title_en')?.value.trim();
      const dept_ar  = document.getElementById('m_dept_ar')?.value.trim();
      const dept_en  = document.getElementById('m_dept_en')?.value.trim();
      const status   = document.getElementById('m_status')?.value;
      const due      = document.getElementById('m_due')?.value || todayISO();
      const owner_ar = document.getElementById('m_owner_ar')?.value.trim();
      const owner_en = document.getElementById('m_owner_en')?.value.trim();
      const objective_ar = document.getElementById('m_obj_ar')?.value.trim();
      const objective_en = document.getElementById('m_obj_en')?.value.trim();
      const scope_ar = document.getElementById('m_scope_ar')?.value.trim();
      const scope_en = document.getElementById('m_scope_en')?.value.trim();
      let progress = Number(document.getElementById('m_progress')?.value ?? 0);
      progress = Math.max(0, Math.min(100, isFinite(progress) ? progress : 0));
      if (status === 'done') progress = 100;

      if (!title_ar && !title_en) { toast(currentLang==='ar'?'Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.':'Please enter a title (AR or EN).', 'warning'); return; }
      if (!dept_ar && !dept_en) { toast(currentLang==='ar'?'Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.':'Please enter a department.', 'warning'); return; }

      if (mode === 'new') {
        const newId = generateMissionId();
        updateStore(s => {
          s.missions.unshift({
            id: newId,
            title_ar: title_ar || '',
            title_en: title_en || title_ar || '',
            dept_ar: dept_ar || '',
            dept_en: dept_en || dept_ar || '',
            status: status || 'planned',
            due,
            scope_ar: scope_ar || '',
            scope_en: scope_en || scope_ar || '',
            objective_ar: objective_ar || '',
            objective_en: objective_en || objective_ar || '',
            owner_ar: owner_ar || '',
            owner_en: owner_en || owner_ar || '',
            progress,
            createdAt: todayISO()
          });
          s.notifications.unshift({
            id: 'n' + Date.now(),
            title_ar: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯Ø©',
            title_en: 'New audit mission added',
            meta_ar: 'Ø§Ù„Ø¢Ù† â€¢ Ø§Ù„Ù†Ø¸Ø§Ù…',
            meta_en: 'Now â€¢ System',
            read: false
          });
          return s;
        });

        closeModal();
        renderView('missions');
        renderNotifications();
        toast(currentLang==='ar'?'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.':'Mission created successfully.', 'success');
        return;
      }

      if (mode === 'edit') {
        updateStore(s => {
          const m = s.missions.find(x => x.id === id);
          if (!m) return s;
          m.title_ar = title_ar || m.title_ar;
          m.title_en = title_en || m.title_en;
          m.dept_ar = dept_ar || m.dept_ar;
          m.dept_en = dept_en || m.dept_en;
          m.status = status || m.status;
          m.due = due;
          m.owner_ar = owner_ar;
          m.owner_en = owner_en;
          m.objective_ar = objective_ar;
          m.objective_en = objective_en;
          m.scope_ar = scope_ar;
          m.scope_en = scope_en;
          m.progress = progress;
          return s;
        });

        closeModal();
        if (currentView === 'missions') renderMissionsTable();
        toast(currentLang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.':'Changes saved.', 'success');
      }
    }

    function generateMissionId() {
      const s = getStore();
      const year = new Date().getFullYear();
      const prefix = `M-${year}-`;
      const nums = s.missions
        .map(m => m.id)
        .filter(id => id.startsWith(prefix))
        .map(id => parseInt(id.slice(prefix.length), 10))
        .filter(n => !isNaN(n));
      const next = (nums.length ? Math.max(...nums) : 0) + 1;
      return prefix + String(next).padStart(3,'0');
    }

    function confirmDeleteMission(id) {
      const s = getStore();
      const m = s.missions.find(x => x.id === id);
      if (!m) return;

      const title = currentLang==='ar' ? m.title_ar : m.title_en;

      const body = `
        <div class="text-sm text-slate-600 dark:text-slate-300">
          ${currentLang==='ar'
            ? `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©: <b class="text-slate-800 dark:text-white">${escapeHtml(title)}</b>ØŸ`
            : `Are you sure you want to delete: <b class="text-slate-800 dark:text-white">${escapeHtml(title)}</b>?`
          }
          <div class="mt-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 text-xs">
            ${currentLang==='ar'
              ? 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª).'
              : 'Note: related findings will be unlinked (findings will not be deleted).'
            }
          </div>
        </div>
      `;

      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-red-600 text-white hover:bg-red-700 transition" onclick="deleteMission('${id}')">
          <i class="fa-solid fa-trash"></i> ${t('delete')}
        </button>
      `;

      openModal(currentLang==='ar'?'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù':'Confirm Delete', body, footer);
    }

    function deleteMission(id) {
      updateStore(s => {
        s.missions = s.missions.filter(m => m.id !== id);
        s.findings.forEach(f => { if (f.relatedMissionId === id) f.relatedMissionId = null; });
        return s;
      });
      closeModal();
      if (currentView === 'missions') renderMissionsTable();
      renderNotifications();
      toast(currentLang==='ar'?'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©.':'Mission deleted.', 'danger');
    }

    // =========================
    // Findings
    // =========================
    function findingsHTML() {
      return `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-5">
            <div>
              <h3 class="font-bold text-lg text-slate-800 dark:text-white">${t('findings_log')}</h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${currentLang==='ar'?'Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø¥ØºÙ„Ø§Ù‚/ØªØµØ¯ÙŠØ± PDF (Demo)':'Add/Edit/Close/Export PDF (Demo)'}</p>
            </div>
            <div class="flex gap-2">
              <button class="bg-brandRed text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-red-600 transition" onclick="openNewFinding()">
                <i class="fa-solid fa-plus"></i> ${t('add_finding')}
              </button>
              <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="openGenerateReport('findings')">
                <i class="fa-solid fa-file-export"></i> ${t('export_pdf')}
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <div class="md:col-span-2">
              <label class="text-xs text-slate-500 dark:text-slate-400">${t('search')}</label>
              <div class="mt-1 flex items-center gap-2 bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3">
                <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                <input id="findingSearch" class="w-full bg-transparent py-3 text-sm outline-none" placeholder="${currentLang==='ar'?'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Search by description, ref, or owner'}"
                  oninput="renderFindingsTable()">
              </div>
            </div>
            <div>
              <label class="text-xs text-slate-500 dark:text-slate-400">${t('filter_status')}</label>
              <select id="findingStateFilter" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                onchange="renderFindingsTable()">
                <option value="all">${t('all')}</option>
                <option value="open">${t('state_open')}</option>
                <option value="progress">${t('state_progress')}</option>
                <option value="closed">${t('state_closed')}</option>
              </select>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-start text-sm text-slate-600 dark:text-slate-300">
              <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">
                <tr>
                  <th class="p-4">${t('col_ref')}</th>
                  <th class="p-4">${t('col_desc')}</th>
                  <th class="p-4">${t('col_risk')}</th>
                  <th class="p-4">${t('col_owner')}</th>
                  <th class="p-4">${t('col_state')}</th>
                  <th class="p-4">${t('col_actions')}</th>
                </tr>
              </thead>
              <tbody id="findingsTbody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderFindingsTable() {
      const s = getStore();
      const tbody = document.getElementById('findingsTbody');
      if (!tbody) return;

      const q = (document.getElementById('findingSearch')?.value || '').trim().toLowerCase();
      const st = document.getElementById('findingStateFilter')?.value || 'all';

      const filtered = s.findings.filter(f => {
        const desc = (currentLang==='ar'?f.desc_ar:f.desc_en).toLowerCase();
        const owner = (currentLang==='ar'?f.owner_ar:f.owner_en).toLowerCase();
        const hit = desc.includes(q) || owner.includes(q) || f.ref.toLowerCase().includes(q);
        const ok = (st==='all') ? true : f.state === st;
        return hit && ok;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-sm text-slate-500">${currentLang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.':'No results found.'}</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(f => {
        const desc = currentLang==='ar'?f.desc_ar:f.desc_en;
        const owner = currentLang==='ar'?f.owner_ar:f.owner_en;
        return `
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
            <td class="p-4 font-mono text-xs">${escapeHtml(f.ref)}</td>
            <td class="p-4">
              <div class="font-bold text-slate-800 dark:text-white">${escapeHtml(desc)}</div>
              ${f.relatedMissionId ? `<div class="text-[11px] text-slate-400 mt-1">${currentLang==='ar'?'Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€':'Linked to'} <span class="font-mono">${escapeHtml(f.relatedMissionId)}</span></div>` : ''}
            </td>
            <td class="p-4">${riskBadge(f.risk)}</td>
            <td class="p-4">${escapeHtml(owner)}</td>
            <td class="p-4">${stateBadge(f.state)}</td>
            <td class="p-4">
              <div class="flex items-center gap-2">
                <button class="text-xs text-brandRed font-bold hover:underline" onclick="openFindingDetails('${f.id}')">${t('btn_details')}</button>
                <span class="text-slate-300">â€¢</span>
                <button class="text-xs text-slate-500 font-bold hover:underline" onclick="openEditFinding('${f.id}')">${t('edit')}</button>
                <span class="text-slate-300">â€¢</span>
                <button class="text-xs text-red-500 font-bold hover:underline" onclick="confirmDeleteFinding('${f.id}')">${t('delete')}</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openNewFinding(missionId=null) {
      const body = findingFormHTML({ mode:'new', relatedMissionId: missionId });
      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="saveFinding('new')">
          <i class="fa-solid fa-check"></i> ${t('save')}
        </button>
      `;
      openModal(currentLang==='ar'?'ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©':'Log Finding', body, footer);
    }

    function openEditFinding(id) {
      const s = getStore();
      const f = s.findings.find(x => x.id === id);
      if (!f) return;

      const body = findingFormHTML({ mode:'edit', finding: f });
      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="saveFinding('edit','${f.id}')">
          <i class="fa-solid fa-check"></i> ${t('save')}
        </button>
      `;
      openModal(currentLang==='ar'?'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©':'Edit Finding', body, footer);
    }

    function findingFormHTML({mode, finding, relatedMissionId}) {
      const s = getStore();
      const missions = s.missions;

      const f = finding || {
        id: '',
        ref: '',
        desc_ar: '',
        desc_en: '',
        risk: 'med',
        owner_ar: '',
        owner_en: '',
        state: 'open',
        relatedMissionId: relatedMissionId || null,
        recommendation_ar: '',
        recommendation_en: '',
        managementResponse_ar: '',
        managementResponse_en: '',
        due: todayISO()
      };

      const refField = (mode === 'edit')
        ? `<div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø±Ø¬Ø¹':'Ref'}: <span class="font-mono font-bold">${escapeHtml(f.ref)}</span></div>`
        : '';

      return `
        <div class="space-y-4">
          ${refField}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)':'Description (AR)'}</label>
              <textarea id="f_desc_ar" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.desc_ar)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ÙˆØµÙ (EN)':'Description (EN)'}</label>
              <textarea id="f_desc_en" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.desc_en)}</textarea>
            </div>

            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©':'Risk'}</label>
              <select id="f_risk" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">
                <option value="low" ${f.risk==='low'?'selected':''}>${t('risk_low')}</option>
                <option value="med" ${f.risk==='med'?'selected':''}>${t('risk_med')}</option>
                <option value="high" ${f.risk==='high'?'selected':''}>${t('risk_high')}</option>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'State'}</label>
              <select id="f_state" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">
                <option value="open" ${f.state==='open'?'selected':''}>${t('state_open')}</option>
                <option value="progress" ${f.state==='progress'?'selected':''}>${t('state_progress')}</option>
                <option value="closed" ${f.state==='closed'?'selected':''}>${t('state_closed')}</option>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø¹Ø±Ø¨ÙŠ)':'Owner (AR)'}</label>
              <input id="f_owner_ar" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(f.owner_ar)}" />
            </div>

            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (EN)':'Owner (EN)'}</label>
              <input id="f_owner_en" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(f.owner_en)}" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø±Ø¨Ø· Ø¨Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)':'Link to Mission (optional)'}</label>
              <select id="f_mission" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">
                <option value="">${currentLang==='ar'?'Ø¨Ø¯ÙˆÙ†':'None'}</option>
                ${missions.map(m => {
                  const label = `${m.id} â€” ${(currentLang==='ar'?m.title_ar:m.title_en)}`;
                  const sel = (f.relatedMissionId === m.id) ? 'selected' : '';
                  return `<option value="${escapeHtml(m.id)}" ${sel}>${escapeHtml(label)}</option>`;
                }).join('')}
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-500">${currentLang==='ar'?'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚':'Due date to close'}</label>
              <input id="f_due" type="date" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none"
                value="${escapeHtml(f.due)}" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ØªÙˆØµÙŠØ© (Ø¹Ø±Ø¨ÙŠ)':'Recommendation (AR)'}</label>
              <textarea id="f_rec_ar" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.recommendation_ar)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ØªÙˆØµÙŠØ© (EN)':'Recommendation (EN)'}</label>
              <textarea id="f_rec_en" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.recommendation_en)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¹Ø±Ø¨ÙŠ)':'Mgmt Response (AR)'}</label>
              <textarea id="f_resp_ar" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.managementResponse_ar)}</textarea>
            </div>
            <div>
              <label class="text-xs text-slate-500">${currentLang==='ar'?'Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (EN)':'Mgmt Response (EN)'}</label>
              <textarea id="f_resp_en" rows="3" class="mt-1 w-full bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 rounded-xl px-3 py-3 text-sm outline-none">${escapeHtml(f.managementResponse_en)}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function saveFinding(mode, id) {
      const desc_ar = document.getElementById('f_desc_ar')?.value.trim();
      const desc_en = document.getElementById('f_desc_en')?.value.trim();
      const risk = document.getElementById('f_risk')?.value || 'med';
      const state = document.getElementById('f_state')?.value || 'open';
      const owner_ar = document.getElementById('f_owner_ar')?.value.trim();
      const owner_en = document.getElementById('f_owner_en')?.value.trim();
      const mission = document.getElementById('f_mission')?.value || null;
      const due = document.getElementById('f_due')?.value || todayISO();
      const recommendation_ar = document.getElementById('f_rec_ar')?.value.trim();
      const recommendation_en = document.getElementById('f_rec_en')?.value.trim();
      const managementResponse_ar = document.getElementById('f_resp_ar')?.value.trim();
      const managementResponse_en = document.getElementById('f_resp_en')?.value.trim();

      if (!desc_ar && !desc_en) { toast(currentLang==='ar'?'Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ ÙˆØµÙ Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.':'Please enter a description (AR or EN).', 'warning'); return; }
      if (!owner_ar && !owner_en) { toast(currentLang==='ar'?'Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.':'Please enter an owner.', 'warning'); return; }

      if (mode === 'new') {
        const ref = generateFindingRef();
        updateStore(s => {
          s.findings.unshift
              updateStore(s => {
          s.findings.unshift({
            id: 'F-' + Date.now(),
            ref,
            desc_ar: desc_ar || '',
            desc_en: desc_en || desc_ar || '',
            risk,
            owner_ar: owner_ar || '',
            owner_en: owner_en || owner_ar || '',
            state,
            relatedMissionId: mission || null,
            recommendation_ar: recommendation_ar || '',
            recommendation_en: recommendation_en || recommendation_ar || '',
            managementResponse_ar: managementResponse_ar || '',
            managementResponse_en: managementResponse_en || managementResponse_ar || '',
            due,
            createdAt: todayISO()
          });

          s.notifications.unshift({
            id: 'n' + Date.now(),
            title_ar: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            title_en: 'New finding logged',
            meta_ar: 'Ø§Ù„Ø¢Ù† â€¢ Ø§Ù„Ù†Ø¸Ø§Ù…',
            meta_en: 'Now â€¢ System',
            read: false
          });
          return s;
        });

        closeModal();
        renderView('findings');
        renderNotifications();
        toast(currentLang==='ar'?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­.':'Finding logged successfully.', 'success');
        return;
      }

      if (mode === 'edit') {
        updateStore(s => {
          const f = s.findings.find(x => x.id === id);
          if (!f) return s;

          f.desc_ar = desc_ar || f.desc_ar;
          f.desc_en = desc_en || f.desc_en;
          f.risk = risk || f.risk;
          f.state = state || f.state;
          f.owner_ar = owner_ar;
          f.owner_en = owner_en;
          f.relatedMissionId = mission || null;
          f.due = due;
          f.recommendation_ar = recommendation_ar;
          f.recommendation_en = recommendation_en;
          f.managementResponse_ar = managementResponse_ar;
          f.managementResponse_en = managementResponse_en;

          return s;
        });

        closeModal();
        if (currentView === 'findings') renderFindingsTable();
        renderNotifications();
        toast(currentLang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.':'Changes saved.', 'success');
      }
    }

    function generateFindingRef() {
      const s = getStore();
      const year = new Date().getFullYear();
      const prefix = `F-${year}-`;
      const nums = s.findings
        .map(f => f.ref)
        .filter(ref => ref.startsWith(prefix))
        .map(ref => parseInt(ref.slice(prefix.length), 10))
        .filter(n => !isNaN(n));
      const next = (nums.length ? Math.max(...nums) : 0) + 1;
      return prefix + String(next).padStart(3,'0');
    }

    function openFindingDetails(id) {
      const s = getStore();
      const f = s.findings.find(x => x.id === id);
      if (!f) return;

      const desc = currentLang==='ar'?f.desc_ar:f.desc_en;
      const owner = currentLang==='ar'?f.owner_ar:f.owner_en;
      const rec = currentLang==='ar'?f.recommendation_ar:f.recommendation_en;
      const resp = currentLang==='ar'?f.managementResponse_ar:f.managementResponse_en;

      const linkedMission = f.relatedMissionId ? s.missions.find(m => m.id === f.relatedMissionId) : null;

      const body = `
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø±Ø¬Ø¹':'Ref'}</div>
              <div class="font-mono text-sm font-bold text-slate-800 dark:text-white">${escapeHtml(f.ref)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'State'}</div>
              <div class="mt-1">${stateBadge(f.state)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©':'Risk'}</div>
              <div class="mt-1">${riskBadge(f.risk)}</div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚':'Due date'}</div>
              <div class="text-sm font-bold text-slate-800 dark:text-white">${escapeHtml(f.due)}</div>
            </div>
          </div>

          ${linkedMission ? `
            <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
              <div class="text-xs text-slate-500">${currentLang==='ar'?'Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…Ù‡Ù…Ø©':'Linked Mission'}</div>
              <div class="mt-1">
                <div class="font-mono text-xs text-slate-400">${escapeHtml(linkedMission.id)}</div>
                <div class="font-bold text-slate-800 dark:text-white">${escapeHtml(currentLang==='ar'?linkedMission.title_ar:linkedMission.title_en)}</div>
              </div>
            </div>
          ` : ''}

          <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
            <div class="text-xs text-slate-500">${currentLang==='ar'?'Ø§Ù„ÙˆØµÙ':'Description'}</div>
            <div class="text-sm font-bold text-slate-800 dark:text-white mt-1">${escapeHtml(desc)}</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„':'Owner'}</div>
                <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">${escapeHtml(owner)}</div>
              </div>
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡':'Created'}</div>
                <div class="text-sm text-slate-600 dark:text-slate-300 mt-1">${escapeHtml(f.createdAt || '')}</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø§Ù„ØªÙˆØµÙŠØ©':'Recommendation'}</div>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 whitespace-pre-line">${escapeHtml(rec || (currentLang==='ar'?'â€”':'â€”'))}</p>
              </div>
              <div>
                <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${currentLang==='ar'?'Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Management Response'}</div>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 whitespace-pre-line">${escapeHtml(resp || (currentLang==='ar'?'â€”':'â€”'))}</p>
              </div>
            </div>
          </div>
        </div>
      `;

      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">
          ${t('close')}
        </button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="openEditFinding('${f.id}')">
          <i class="fa-solid fa-pen"></i> ${t('edit')}
        </button>
      `;

      openModal(currentLang==='ar'?'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©':'Finding Details', body, footer);
    }

    function confirmDeleteFinding(id) {
      const s = getStore();
      const f = s.findings.find(x => x.id === id);
      if (!f) return;

      const desc = currentLang==='ar' ? f.desc_ar : f.desc_en;

      const body = `
        <div class="text-sm text-slate-600 dark:text-slate-300">
          ${currentLang==='ar'
            ? `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: <b class="text-slate-800 dark:text-white">${escapeHtml(f.ref)}</b>ØŸ`
            : `Are you sure you want to delete: <b class="text-slate-800 dark:text-white">${escapeHtml(f.ref)}</b>?`
          }
          <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">${escapeHtml(desc)}</div>
        </div>
      `;

      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-red-600 text-white hover:bg-red-700 transition" onclick="deleteFinding('${id}')">
          <i class="fa-solid fa-trash"></i> ${t('delete')}
        </button>
      `;

      openModal(currentLang==='ar'?'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù':'Confirm Delete', body, footer);
    }

    function deleteFinding(id) {
      updateStore(s => {
        s.findings = s.findings.filter(f => f.id !== id);
        return s;
      });
      closeModal();
      if (currentView === 'findings') renderFindingsTable();
      renderNotifications();
      toast(currentLang==='ar'?'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.':'Finding deleted.', 'danger');
    }

    // =========================
    // Reports
    // =========================
    function reportsHTML() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
          <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6">
            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">${t('audit_reports')}</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-6">
              ${currentLang==='ar'?'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø«Ù… Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯. Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ ÙƒÙ€ PDF (Demo).':'Pick a report type then generate. PDF will download (Demo).'}
            </p>

            <div class="space-y-3">
              ${reportCard('summary', t('rep_summary'), currentLang==='ar'?'Ù…Ù„Ø®Øµ Ù…Ø¤Ø´Ø±Ø§Øª + Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.':'KPIs summary + missions/findings status.')}
              ${reportCard('followup', t('rep_followup'), currentLang==='ar'?'Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆÙ‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©.':'Follow-up for open/in-progress findings by risk.')}
              ${reportCard('missions', t('rep_missions'), currentLang==='ar'?'Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆÙ†Ø·Ø§Ù‚Ù‡Ø§ ÙˆØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª.':'List missions, scope, and due dates.')}
              ${reportCard('findings', currentLang==='ar'?'ØªÙ‚Ø±ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Findings Log Report', currentLang==='ar'?'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¹ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.':'Findings with recommendations and management responses.')}
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6">
            <h3 class="font-bold text-slate-800 dark:text-white mb-3">${currentLang==='ar'?'Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Notes'}</h3>
            <div class="text-xs text-slate-600 dark:text-slate-300 space-y-2">
              <div class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
                â€¢ ${currentLang==='ar'?'Ø§Ù„Ù€ PDF Ù‡Ù†Ø§ Ø¯ÙŠÙ…Ùˆ (ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø³ÙŠØ·).':'PDF is demo (simple formatting).'}
              </div>
              <div class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700">
                â€¢ ${currentLang==='ar'?'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ LocalStorage Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.':'Data is stored in LocalStorage on your device.'}
              </div>
              <button class="w-full mt-2 px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition"
                onclick="resetDemo()">
                <i class="fa-solid fa-rotate"></i> ${currentLang==='ar'?'Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙŠÙ…Ùˆ':'Reset Demo'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function reportCard(type, title, desc) {
      return `
        <div class="p-4 rounded-2xl border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/30">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-bold text-slate-800 dark:text-white">${escapeHtml(title)}</div>
              <div class="text-xs text-slate-500 dark:text-slate-300 mt-1">${escapeHtml(desc)}</div>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-lg text-xs font-bold bg-brandRed text-white hover:bg-red-600 transition"
                onclick="openGenerateReport('${type}')">
                <i class="fa-solid fa-wand-magic-sparkles"></i> ${t('btn_generate')}
              </button>
              <button class="px-3 py-2 rounded-lg text-xs font-bold border border-slate-200 dark:border-slate-700 hover:bg-white/60 dark:hover:bg-slate-700 transition"
                onclick="downloadReportPDF('${type}')">
                <i class="fa-solid fa-download"></i> ${t('btn_download')}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function openGenerateReport(type) {
      const titleMap = {
        summary: t('rep_summary'),
        followup: t('rep_followup'),
        missions: t('rep_missions'),
        findings: currentLang==='ar'?'ØªÙ‚Ø±ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Findings Log Report'
      };
      const title = titleMap[type] || 'Report';

      const body = `
        <div class="space-y-3">
          <div class="text-sm text-slate-600 dark:text-slate-300">
            ${currentLang==='ar'
              ? 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.'
              : 'A PDF will be generated from current data.'}
          </div>
          <div class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 border border-slate-100 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-300">
            â€¢ ${currentLang==='ar'?'Ø§Ù„Ù†ÙˆØ¹':'Type'}: <b>${escapeHtml(title)}</b><br/>
            â€¢ ${currentLang==='ar'?'Ø§Ù„ØªØ§Ø±ÙŠØ®':'Date'}: <b>${escapeHtml(todayISO())}</b>
          </div>
        </div>
      `;

      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="downloadReportPDF('${type}'); closeModal();">
          <i class="fa-solid fa-file-arrow-down"></i> ${t('btn_download')}
        </button>
      `;

      openModal(currentLang==='ar'?'ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±':'Generate Report', body, footer);
    }

    function downloadReportPDF(type) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

      const s = getStore();
      const margin = 40;
      let y = 48;

      const titleMap = {
        summary: t('rep_summary'),
        followup: t('rep_followup'),
        missions: t('rep_missions'),
        findings: currentLang==='ar'?'ØªÙ‚Ø±ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Findings Log Report'
      };
      const reportTitle = titleMap[type] || 'Report';

      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);
      doc.text(`AndroGov â€” ${reportTitle}`, margin, y);
      y += 18;

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.text(`Date: ${todayISO()}  |  Language: ${currentLang.toUpperCase()}`, margin, y);
      y += 22;

      const line = () => { doc.setDrawColor(220); doc.line(margin, y, 555, y); y += 18; };

      const addSectionTitle = (txt) => {
        doc.setFont('helvetica','bold');
        doc.setFontSize(12);
        doc.text(txt, margin, y);
        y += 14;
        doc.setFont('helvetica','normal');
        doc.setFontSize(10);
      };

      const addText = (txt) => {
        const maxW = 515;
        const lines = doc.splitTextToSize(String(txt || ''), maxW);
        lines.forEach(l => {
          if (y > 780) { doc.addPage(); y = 48; }
          doc.text(l, margin, y);
          y += 14;
        });
      };

      const riskLabel = (r) => ({low:t('risk_low'), med:t('risk_med'), high:t('risk_high')}[r] || r);
      const stateLabel = (st) => ({open:t('state_open'), progress:t('state_progress'), closed:t('state_closed')}[st] || st);
      const stMission = (st) => ({planned:t('status_planned'), ongoing:t('status_ongoing'), done:t('status_done')}[st] || st);

      if (type === 'summary') {
        const openFindings = s.findings.filter(f => f.state !== 'closed').length;
        const urgentActions = s.findings.filter(f => f.risk === 'high' && f.state !== 'closed').length;
        const completed = s.missions.filter(m => m.status === 'done').length;
        const total = Math.max(1, s.missions.length);
        const progress = Math.round((completed / total) * 100);

        addSectionTitle('Key Metrics');
        addText(`Annual Plan Progress: ${progress}%`);
        addText(`Open Findings: ${openFindings}`);
        addText(`High Risk Open Findings: ${urgentActions}`);
        addText(`Missions (Total/Completed): ${s.missions.length}/${completed}`);
        line();

        addSectionTitle('Missions Status');
        s.missions.forEach(m => {
          if (y > 780) { doc.addPage(); y = 48; }
          addText(`â€¢ ${m.id} â€” ${currentLang==='ar'?m.title_ar:m.title_en} | ${stMission(m.status)} | Due: ${m.due}`);
        });
        line();

        addSectionTitle('Findings Snapshot');
        s.findings.forEach(f => {
          if (y > 780) { doc.addPage(); y = 48; }
          addText(`â€¢ ${f.ref} | ${riskLabel(f.risk)} | ${stateLabel(f.state)} | Owner: ${currentLang==='ar'?f.owner_ar:f.owner_en}`);
        });
      }

      if (type === 'followup') {
        addSectionTitle('Open / In Progress Findings');
        const list = s.findings.filter(f => f.state !== 'closed');
        if (!list.length) addText('â€”');
        list.forEach(f => {
          if (y > 780) { doc.addPage(); y = 48; }
          addText(`${f.ref} | Risk: ${riskLabel(f.risk)} | State: ${stateLabel(f.state)} | Due: ${f.due}`);
          addText(`Desc: ${currentLang==='ar'?f.desc_ar:f.desc_en}`);
          addText(`Rec: ${currentLang==='ar'?f.recommendation_ar:f.recommendation_en}`);
          addText(`Resp: ${currentLang==='ar'?f.managementResponse_ar:f.managementResponse_en}`);
          y += 6;
        });
      }

      if (type === 'missions') {
        addSectionTitle('Audit Missions');
        if (!s.missions.length) addText('â€”');
        s.missions.forEach(m => {
          if (y > 780) { doc.addPage(); y = 48; }
          addText(`${m.id} | ${stMission(m.status)} | Dept: ${currentLang==='ar'?m.dept_ar:m.dept_en} | Due: ${m.due}`);
          addText(`Title: ${currentLang==='ar'?m.title_ar:m.title_en}`);
          addText(`Objective: ${currentLang==='ar'?m.objective_ar:m.objective_en}`);
          addText(`Scope: ${currentLang==='ar'?m.scope_ar:m.scope_en}`);
          addText(`Owner: ${currentLang==='ar'?m.owner_ar:m.owner_en} | Progress: ${m.progress || 0}%`);
          y += 6;
        });
      }

      if (type === 'findings') {
        addSectionTitle('Findings Log');
        if (!s.findings.length) addText('â€”');
        s.findings.forEach(f => {
          if (y > 780) { doc.addPage(); y = 48; }
          addText(`${f.ref} | Risk: ${riskLabel(f.risk)} | State: ${stateLabel(f.state)} | Due: ${f.due}`);
          if (f.relatedMissionId) addText(`Linked Mission: ${f.relatedMissionId}`);
          addText(`Owner: ${currentLang==='ar'?f.owner_ar:f.owner_en}`);
          addText(`Desc: ${currentLang==='ar'?f.desc_ar:f.desc_en}`);
          addText(`Recommendation: ${currentLang==='ar'?f.recommendation_ar:f.recommendation_en}`);
          addText(`Mgmt Response: ${currentLang==='ar'?f.managementResponse_ar:f.managementResponse_en}`);
          y += 6;
        });
      }

      const safeType = String(type || 'report').replace(/[^a-z0-9_-]/gi,'');
      doc.save(`AndroGov_${safeType}_${todayISO()}.pdf`);
      toast(currentLang==='ar'?'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.':'Report downloaded.', 'success');
    }

    // =========================
    // Profile (HR)
    // =========================
    function profileHTML() {
      const s = getStore();
      const p = s.profile;

      const name = currentLang==='ar'?p.name_ar:p.name_en;
      const role = currentLang==='ar'?p.role_ar:p.role_en;

      const attendRows = p.attendance.map(a => `
        <tr class="border-b border-slate-100 dark:border-slate-700">
          <td class="p-3 text-xs">${escapeHtml(currentLang==='ar'?a.date_ar:a.date_en)}</td>
          <td class="p-3 text-xs font-bold">${escapeHtml(currentLang==='ar'?a.in_ar:a.in_en)}</td>
          <td class="p-3 text-xs font-bold">${escapeHtml(currentLang==='ar'?a.out_ar:a.out_en)}</td>
          <td class="p-3 text-xs">${escapeHtml(currentLang==='ar'?a.status_ar:a.status_en)}</td>
        </tr>
      `).join('');

      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
          <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-brandRed text-white flex items-center justify-center font-extrabold shadow-lg">IA</div>
              <div class="min-w-0">
                <div class="text-lg font-extrabold text-slate-800 dark:text-white truncate">${escapeHtml(name)}</div>
                <div class="text-xs text-slate-500 dark:text-slate-300">${escapeHtml(role)} â€¢ ID: <span class="font-mono">${escapeHtml(p.employeeId)}</span></div>
              </div>
              <div class="ms-auto">
                <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200">
                  ${t('on_job')}
                </span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
              ${miniCard(t('leave_bal'), `${p.leaveBalance} ${currentLang==='ar'?'ÙŠÙˆÙ…':'Days'}`, 'fa-umbrella-beach')}
              ${miniCard(t('commit_score'), `${p.commitment}%`, 'fa-shield-heart')}
              ${miniCard(currentLang==='ar'?'Ø¢Ø®Ø± Ø­Ø±ÙƒØ©':'Last Action', p.lastCheck ? escapeHtml(p.lastCheck) : (currentLang==='ar'?'â€”':'â€”'), 'fa-clock')}
            </div>

            <div class="mt-6">
              <div class="flex items-center justify-between">
                <h4 class="font-bold text-slate-800 dark:text-white">${t('attend_log')}</h4>
                <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="toggleCheckin()">
                  <i class="fa-solid fa-fingerprint"></i> ${t('btn_checkin')}
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-start text-slate-600 dark:text-slate-300">
                  <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">
                    <tr>
                      <th class="p-3">${currentLang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'}</th>
                      <th class="p-3">${currentLang==='ar'?'Ø¯Ø®ÙˆÙ„':'In'}</th>
                      <th class="p-3">${currentLang==='ar'?'Ø®Ø±ÙˆØ¬':'Out'}</th>
                      <th class="p-3">${currentLang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'Status'}</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                    ${attendRows}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6">
            <h4 class="font-bold text-slate-800 dark:text-white mb-4">${currentLang==='ar'?'Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù':'Employee Services'}</h4>
            <div class="space-y-3">
              <button class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 hover:bg-red-50 dark:hover:bg-slate-700 transition text-start"
                onclick="toast(currentLang==='ar'?'ØªÙ… ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© (Demo).':'Leave request opened (Demo).','info')">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-plane-departure text-slate-400"></i>
                  <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${t('btn_leave')}</div>
                </div>
              </button>

              <button class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 hover:bg-red-50 dark:hover:bg-slate-700 transition text-start"
                onclick="downloadSalaryCertificate()">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-file-signature text-slate-400"></i>
                  <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${t('btn_salary')}</div>
                </div>
              </button>

              <button class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700/40 hover:bg-red-50 dark:hover:bg-slate-700 transition text-start"
                onclick="toast(currentLang==='ar'?'ØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø¹Ù… (Demo).':'Support opened (Demo).','info')">
                <div class="flex items-center gap-2">
                  <i class="fa-solid fa-headset text-slate-400"></i>
                  <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${t('btn_support')}</div>
                </div>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function miniCard(label, value, icon) {
      return `
        <div class="p-4 rounded-2xl border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/30">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 flex items-center justify-center">
              <i class="fa-solid ${icon} text-brandRed"></i>
            </div>
            <div class="min-w-0">
              <div class="text-xs text-slate-500 dark:text-slate-300">${escapeHtml(label)}</div>
              <div class="text-sm font-extrabold text-slate-800 dark:text-white truncate">${escapeHtml(value)}</div>
            </div>
          </div>
        </div>
      `;
    }

    function toggleCheckin() {
      updateStore(s => {
        s.profile.lastCheck = (new Date()).toLocaleString(currentLang==='ar'?'ar-SA':'en-US');
        return s;
      });
      renderView('profile');
      toast(currentLang==='ar'?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© (Demo).':'Action recorded (Demo).','success');
    }

    function downloadSalaryCertificate() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      const s = getStore();
      const p = s.profile;

      const name = currentLang==='ar'?p.name_ar:p.name_en;
      const role = currentLang==='ar'?p.role_ar:p.role_en;

      let y = 60;
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text(currentLang==='ar'?'Salary Certificate (Demo)':'Salary Certificate (Demo)', 40, y);
      y += 24;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Date: ${todayISO()}`, 40, y); y += 18;
      doc.text(`Employee: ${name}`, 40, y); y += 18;
      doc.text(`Role: ${role}`, 40, y); y += 18;
      doc.text(`Employee ID: ${p.employeeId}`, 40, y); y += 18;

      y += 8;
      doc.setDrawColor(220); doc.line(40, y, 555, y); y += 22;

      doc.setFontSize(10);
      doc.text('This is a demo certificate generated by AndroGov UI (non-official).', 40, y);

      doc.save(`AndroGov_SalaryCertificate_${todayISO()}.pdf`);
      toast(currentLang==='ar'?'ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø±Ø§ØªØ¨ (Demo).':'Salary certificate downloaded (Demo).','success');
    }

    // =========================
    // Reset / Logout
    // =========================
    function resetDemo() {
      localStorage.removeItem(STORE_KEY);
      renderNotifications();
      renderView(currentView);
      toast(currentLang==='ar'?'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…Ùˆ.':'Demo data reset.', 'warning');
    }

    function logout() {
      const body = `
        <div class="text-sm text-slate-600 dark:text-slate-300">
          ${currentLang==='ar'
            ? 'Ù‡Ø°Ø§ Ø¯ÙŠÙ…Ùˆ. Ø³ÙŠØªÙ… ÙÙ‚Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù….'
            : 'This is a demo. UI will reset and menus will close.'}
        </div>
      `;
      const footer = `
        <button class="px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition" onclick="closeModal()">${t('cancel')}</button>
        <button class="px-4 py-2 rounded-lg text-sm font-bold bg-brandRed text-white hover:bg-red-600 transition" onclick="closeModal(); toggleAI(false); document.getElementById('notifDropdown').classList.add('hidden'); toast(currentLang==='ar'?'ØªÙ….':'Done.','info');">
          ${t('confirm')}
        </button>
      `;
      openModal(currentLang==='ar'?'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬':'Logout', body, footer);
    }

    // =========================
    // Global handlers / Init
    // =========================
    function closeDropdownsOnOutsideClick(e) {
      const dd = document.getElementById('notifDropdown');
      const wrap = document.getElementById('notifWrap');
      if (!wrap.contains(e.target)) dd.classList.add('hidden');
    }

    document.addEventListener('click', closeDropdownsOnOutsideClick);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close modal first
        const modalActive = document.getElementById('modal')?.classList.contains('active');
        if (modalActive) { closeModal(); return; }
        // Close AI
        if (aiOpen) { toggleAI(false); return; }
        // Close sidebar on mobile
        if (window.innerWidth < 768) {
          const sb = document.getElementById('sidebar');
          if (sb.classList.contains('open')) toggleSidebar();
        }
      }
    });

    (function initApp() {
      // theme
      const th = localStorage.getItem('theme') || 'light';
      if (th === 'dark') document.documentElement.classList.add('dark');
      document.getElementById('themeIcon').className = isDark() ? 'fa-solid fa-sun' : 'fa-solid fa-moon';

      // lang
      currentLang = localStorage.getItem('lang') || 'ar';
      applyLanguage();

      // seed store
      getStore();

      // UI
      renderNotifications();
      initChat();
      positionAI();
      renderView('dashboard');
    })();
  </script>
</body>
</html>    
