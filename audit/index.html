<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AndroGov | Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brandRed: '#FB4747',
            brandDark: '#0F172A',
            brandGray: '#F8FAFC',
          },
          fontFamily: { sans: ['Tajawal', 'Inter', 'sans-serif'], en: ['Inter', 'sans-serif'] }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    .dark ::-webkit-scrollbar-thumb { background-color: #475569; }

    /* Animation */
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Mobile Sidebar Overlay */
    .sidebar-overlay { background: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 40; display: none; backdrop-filter: blur(2px); }
    .sidebar-overlay.active { display: block; }

    /* Notification Pulse */
    .notification-pulse { animation: pulse-red 2s infinite; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(251, 71, 71, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(251, 71, 71, 0); }
      100% { box-shadow: 0 0 0 0 rgba(251, 71, 71, 0); }
    }
    
    .hidden { display: none !important; }

    /* Responsive Sidebar */
    @media (max-width: 768px) {
      #sidebar { position: fixed; right: -100%; top: 0; height: 100%; transition: right 0.3s ease-in-out; z-index: 50; }
      #sidebar.open { right: 0; }
      html[dir="ltr"] #sidebar { left: -100%; right: auto; transition: left 0.3s ease-in-out; }
      html[dir="ltr"] #sidebar.open { left: 0; }
    }

    /* AI Chat */
    .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
    .chat-ai { background-color: #FB4747; color: white; border-bottom-left-radius: 2px; }
    .chat-user { background-color: #f1f5f9; color: #1e293b; border-bottom-right-radius: 2px; }
    .dark .chat-user { background-color: #334155; color: white; }

    #aiSidebar {
      position: fixed; top: 0; height: 100%; width: 100%; max-width: 24rem; z-index: 60;
      transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    html[dir="ltr"] #aiSidebar { transform: translateX(120%); } /* Logic handled in JS */
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 70; display: none; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: block; }
    .modal { position: fixed; inset: 0; z-index: 80; display: none; align-items: center; justify-content: center; padding: 16px; pointer-events: none; }
    .modal.active { display: flex; pointer-events: auto; }
    .modal-content { pointer-events: auto; transform: scale(0.95); opacity: 0; transition: all 0.2s; }
    .modal.active .modal-content { transform: scale(1); opacity: 1; }
  </style>
</head>

<body class="bg-brandGray dark:bg-[#0F172A] text-slate-800 dark:text-slate-100 h-screen overflow-hidden flex font-sans transition-colors duration-300">

  <div id="mobileOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
  
  <div id="toastContainer" class="fixed top-6 z-[90] flex flex-col gap-2 transition-all duration-300 pointer-events-none" style="right:24px;"></div>

  <aside id="sidebar" class="w-72 bg-white dark:bg-[#0F172A] border-l dark:border-slate-800 flex flex-col shadow-xl shrink-0 h-full">
    <div class="h-20 flex items-center px-6 border-b border-slate-100 dark:border-slate-800 bg-white dark:bg-[#0F172A] shrink-0">
      <div class="flex items-center gap-3 w-full">
        <div class="w-10 h-10 rounded-xl bg-brandRed text-white flex items-center justify-center font-bold text-xl shrink-0">A</div>
        <div class="overflow-hidden">
          <h1 class="font-bold text-sm text-slate-800 dark:text-white truncate">AndroGov Audit</h1>
          <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider truncate" data-i18n="sidebar_subtitle">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</p>
        </div>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scroll">
      <div class="px-3 mt-2 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      
      <button onclick="renderView('dashboard')" class="w-full flex items-center gap-3 px-3 py-2.5 bg-brandRed text-white rounded-xl shadow-lg shadow-red-500/20 font-bold transition nav-item" id="nav-dashboard">
        <div class="w-6 text-center"><i class="fa-solid fa-gauge-high"></i></div>
        <span class="flex-1 text-start truncate" data-i18n="overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span>
      </button>

      <div class="px-3 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>

      <button onclick="renderView('missions')" class="w-full flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-brandRed rounded-xl transition nav-item" id="nav-missions">
        <div class="w-6 text-center"><i class="fa-solid fa-list-check"></i></div>
        <span class="flex-1 text-start truncate" data-i18n="missions">Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</span>
      </button>
      <button onclick="renderView('findings')" class="w-full flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-brandRed rounded-xl transition nav-item" id="nav-findings">
        <div class="w-6 text-center"><i class="fa-solid fa-bug"></i></div>
        <span class="flex-1 text-start truncate" data-i18n="findings">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
      </button>
      <button onclick="renderView('reports')" class="w-full flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-brandRed rounded-xl transition nav-item" id="nav-reports">
        <div class="w-6 text-center"><i class="fa-solid fa-file-contract"></i></div>
        <span class="flex-1 text-start truncate" data-i18n="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©</span>
      </button>

      <div class="px-3 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="self_service">Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</div>

      <button onclick="renderView('profile')" class="w-full flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-brandRed rounded-xl transition nav-item" id="nav-profile">
        <div class="w-6 text-center"><i class="fa-solid fa-id-card"></i></div>
        <span class="flex-1 text-start truncate" data-i18n="profile_hr">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</span>
      </button>
    </nav>

    <div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-[#0F172A] transition shrink-0">
      <div class="flex items-center gap-3">
        <div class="relative">
          <img src="https://ui-avatars.com/api/?name=Ali+Alghamdi&background=FB4747&color=fff" class="w-9 h-9 rounded-full border-2 border-slate-100 dark:border-slate-700">
          <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-slate-800 rounded-full"></span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-xs font-bold truncate text-slate-800 dark:text-white" data-i18n="user_name">Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</p>
          <p class="text-[10px] text-slate-500 truncate" data-i18n="user_role">Internal Auditor</p>
        </div>
        <a href="../login.html" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-400 hover:text-red-500 transition" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">
          <i class="fa-solid fa-power-off text-xs"></i>
        </a>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-brandGray dark:bg-[#0F172A]">
    
    <header class="h-20 bg-white/80 dark:bg-[#0F172A]/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 shrink-0 z-20 sticky top-0">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="md:hidden text-slate-500 dark:text-white hover:text-brandRed transition">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <div>
          <h2 class="text-lg font-bold text-slate-800 dark:text-white" id="pageTitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
          <p class="text-[10px] text-slate-500 dark:text-slate-400 mt-0.5">Andromeda Audit System v2.1</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative" id="notifWrap">
          <button onclick="toggleNotifications()" class="w-9 h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-white transition relative flex items-center justify-center">
            <i class="fa-regular fa-bell"></i>
            <span id="notifDot" class="absolute top-2 right-2.5 w-2 h-2 bg-brandRed rounded-full border border-white dark:border-slate-800 animate-pulse"></span>
          </button>

          <div id="notifDropdown" class="hidden absolute top-12 left-0 w-80 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 z-50 overflow-hidden">
            <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
              <span class="text-xs font-bold text-slate-800 dark:text-white" data-i18n="notif_title">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
              <button class="text-[10px] text-brandRed hover:underline" onclick="markAllRead()" data-i18n="read_all">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button>
            </div>
            <div class="max-h-64 overflow-y-auto custom-scroll" id="notifList"></div>
          </div>
        </div>

        <button onclick="toggleAI(true)" class="w-9 h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-brandBlue transition flex items-center justify-center" title="Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ">
          <i class="fa-solid fa-robot"></i>
        </button>

        <button onclick="toggleLanguage()" class="h-9 px-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-xs font-bold text-slate-600 dark:text-white transition" id="langLabel">EN</button>

        <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-lg border border-slate-200 dark:border-slate-700 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-yellow-400 transition">
          <i id="themeIcon" class="fa-solid fa-moon"></i>
        </button>
      </div>
    </header>

    <div id="mainContent" class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll"></div>
  </main>

  <aside id="aiSidebar" class="bg-white dark:bg-slate-800 shadow-2xl border-r dark:border-slate-700 flex flex-col">
    <div class="h-20 flex items-center justify-between px-6 bg-gradient-to-r from-brandRed to-red-600 text-white shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
        <div>
          <h3 class="font-bold text-sm" data-i18n="ai_title">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ</h3>
          <p class="text-[10px] text-white/80" id="aiPowered">AndroGov AI</p>
        </div>
      </div>
      <button onclick="toggleAI(false)" class="text-white/80 hover:text-white transition">
        <i class="fa-solid fa-xmark text-lg"></i>
      </button>
    </div>

    <div id="chatArea" class="flex-1 bg-slate-50 dark:bg-slate-900/50 p-4 overflow-y-auto flex flex-col custom-scroll"></div>

    <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shrink-0">
      <div class="flex gap-2 relative">
        <input id="aiInput" type="text" placeholder="..." class="flex-1 bg-slate-100 dark:bg-slate-900 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-brandRed dark:text-white transition-all outline-none"
          onkeydown="if(event.key === 'Enter') sendAIMessage()">
        <button onclick="sendAIMessage()" class="bg-brandRed hover:bg-red-700 text-white w-12 rounded-xl transition-colors flex items-center justify-center shadow-lg shadow-red-500/30">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </aside>

  <div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>

  <div id="modal" class="modal">
    <div class="w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden max-h-[90vh] flex flex-col modal-content">
      <div class="p-4 md:p-5 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between bg-slate-50 dark:bg-slate-900 shrink-0">
        <h3 class="font-bold text-slate-800 dark:text-white" id="modalTitle">Modal</h3>
        <button class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition flex items-center justify-center"
          onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="p-4 md:p-6 overflow-y-auto flex-1 custom-scroll" id="modalBody"></div>
      <div class="p-4 md:p-5 border-t border-slate-100 dark:border-slate-700 flex items-center justify-end gap-2 bg-slate-50 dark:bg-slate-900 shrink-0" id="modalFooter"></div>
    </div>
  </div>

  <script>
    // =========================
    // i18n & Config
    // =========================
    const translations = {
      ar: {
        sidebar_subtitle: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ",
        overview: "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©",
        missions: "Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        findings: "Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        self_service: "Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø°Ø§ØªÙŠØ©",
        profile_hr: "Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (HR)",
        user_name: "Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
        user_role: "Ù…Ø¯Ù‚Ù‚ Ø¯Ø§Ø®Ù„ÙŠ",
        notif_title: "Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",
        read_all: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„",
        ai_title: "Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ",
        ai_welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹\nØ£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø¯ÙŠÙ…Ùˆ Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ. Ø§ÙƒØªØ¨: (Ù…Ù„Ø§Ø­Ø¸Ø©) Ø£Ùˆ (Ø®Ø·Ø©) Ø£Ùˆ (ØªÙ‚Ø±ÙŠØ±) ÙˆØ³Ø£Ù‚ØªØ±Ø­ Ù„Ùƒ Ø®Ø·ÙˆØ§Øª Ø¬Ø§Ù‡Ø²Ø©.",
        plan_progress: "Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©",
        open_findings: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø©",
        urgent_actions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ø§Ø¬Ù„Ø©",
        audit_coverage: "ØªØºØ·ÙŠØ© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        audit_status: "Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        completed: "Ù…ÙƒØªÙ…Ù„",
        in_progress: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
        planned: "Ù…Ø®Ø·Ø·",
        quick_actions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
        new_mission: "Ù…Ù‡Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯Ø©",
        add_finding: "ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©",
        generate_report: "Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ±",
        audit_missions: "Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        search: "Ø¨Ø­Ø«",
        filter_status: "ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø©",
        all: "Ø§Ù„ÙƒÙ„",
        status_planned: "Ù…Ø®Ø·Ø·",
        status_ongoing: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
        status_done: "Ù…ÙƒØªÙ…Ù„",
        col_mission: "Ø§Ù„Ù…Ù‡Ù…Ø©",
        col_dept: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
        col_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
        col_due: "Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
        col_actions: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
        btn_details: "Ø§Ù„ØªÙØ§ØµÙŠÙ„",
        findings_log: "Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª",
        col_ref: "Ø§Ù„Ù…Ø±Ø¬Ø¹",
        col_desc: "Ø§Ù„ÙˆØµÙ",
        col_risk: "Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©",
        col_owner: "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
        col_state: "Ø§Ù„Ø­Ø§Ù„Ø©",
        risk_low: "Ù…Ù†Ø®ÙØ¶Ø©",
        risk_med: "Ù…ØªÙˆØ³Ø·Ø©",
        risk_high: "Ø¹Ø§Ù„ÙŠØ©",
        state_open: "Ù…ÙØªÙˆØ­Ø©",
        state_progress: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
        state_closed: "Ù…Ù‚ÙÙ„Ø©",
        audit_reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©",
        btn_download: "ØªØ­Ù…ÙŠÙ„ PDF",
        btn_generate: "ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±",
        rep_summary: "ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø±Ù‚Ø§Ø¨ÙŠ",
        rep_followup: "ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        rep_missions: "ØªÙ‚Ø±ÙŠØ± Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
        on_job: "Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…Ù„",
        leave_bal: "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª",
        days_25: "22 ÙŠÙˆÙ…",
        commit_score: "Ù…Ø¤Ø´Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…",
        btn_checkin: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±",
        btn_leave: "Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©",
        btn_salary: "ØªØ¹Ø±ÙŠÙ Ø±Ø§ØªØ¨",
        btn_support: "Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
        attend_log: "Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø¢Ø®Ø± 3 Ø£ÙŠØ§Ù…)",
        save: "Ø­ÙØ¸",
        cancel: "Ø¥Ù„ØºØ§Ø¡",
        close: "Ø¥ØºÙ„Ø§Ù‚",
        confirm: "ØªØ£ÙƒÙŠØ¯",
        edit: "ØªØ¹Ø¯ÙŠÙ„",
        delete: "Ø­Ø°Ù",
        export_pdf: "ØªØµØ¯ÙŠØ± PDF"
      },
      en: {
        sidebar_subtitle: "Internal Audit Portal",
        overview: "Overview",
        missions: "Audit Missions",
        findings: "Findings Log",
        reports: "Audit Reports",
        self_service: "Self Service",
        profile_hr: "My Profile (HR)",
        user_name: "Ali Alghamdi",
        user_role: "Internal Auditor",
        notif_title: "Notifications",
        read_all: "Read All",
        ai_title: "Audit Consultant",
        ai_welcome: "Hello ğŸ‘‹\nIâ€™m a demo audit assistant. Type: (finding) or (plan) or (report) and Iâ€™ll propose ready steps.",
        plan_progress: "Annual Plan Progress",
        open_findings: "Open Findings",
        urgent_actions: "Urgent Actions",
        audit_coverage: "Audit Coverage",
        audit_status: "Audit Tasks Status",
        completed: "Completed",
        in_progress: "In Progress",
        planned: "Planned",
        quick_actions: "Quick Actions",
        new_mission: "New Audit Mission",
        add_finding: "Log Finding",
        generate_report: "Generate Report",
        audit_missions: "Audit Missions",
        search: "Search",
        filter_status: "Status Filter",
        all: "All",
        status_planned: "Planned",
        status_ongoing: "Ongoing",
        status_done: "Completed",
        col_mission: "Mission",
        col_dept: "Department",
        col_status: "Status",
        col_due: "Due",
        col_actions: "Actions",
        btn_details: "Details",
        findings_log: "Findings & Violations Log",
        col_ref: "Ref",
        col_desc: "Description",
        col_risk: "Risk",
        col_owner: "Owner",
        col_state: "State",
        risk_low: "Low",
        risk_med: "Medium",
        risk_high: "High",
        state_open: "Open",
        state_progress: "In Progress",
        state_closed: "Closed",
        audit_reports: "Audit Reports",
        btn_download: "Download PDF",
        btn_generate: "Generate",
        rep_summary: "Audit Summary Report",
        rep_followup: "Follow-up Report",
        rep_missions: "Missions Report",
        on_job: "Active",
        leave_bal: "Leave Balance",
        days_25: "22 Days",
        commit_score: "Commitment Score",
        btn_checkin: "Check In/Out",
        btn_leave: "Request Leave",
        btn_salary: "Salary Certificate",
        btn_support: "Support",
        attend_log: "Attendance Log (3 Days)",
        save: "Save",
        cancel: "Cancel",
        close: "Close",
        confirm: "Confirm",
        edit: "Edit",
        delete: "Delete",
        export_pdf: "Export PDF"
      }
    };

    let currentLang = localStorage.getItem('lang') || 'ar';
    let currentView = 'dashboard';
    let auditChart = null;
    const STORE_KEY = "AndroGovDemoStore_v1";

    function todayISO() {
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function seedStore() {
      return {
        notifications: [
          { id: "n1", title_ar: "Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", title_en: "Finance Dept Response", meta_ar: "Ù…Ù†Ø° Ø³Ø§Ø¹Ø© â€¢ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ", meta_en: "1h ago â€¢ CFO", read: false },
          { id: "n2", title_ar: "Ù…ÙˆØ¹Ø¯ ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©", title_en: "HR Audit Scheduled", meta_ar: "ØºØ¯Ø§Ù‹ 9:00 Øµ â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯", meta_en: "Tomorrow 9:00 AM â€¢ HR Dept", read: false }
        ],
        missions: [
          { id: "M-2025-001", title_ar: "ØªØ¯Ù‚ÙŠÙ‚ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«", title_en: "Q3 Procurement Audit", dept_ar: "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", dept_en: "Procurement", status: "ongoing", due: "2025-11-20", scope_ar: "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹ÙŠÙ‘Ù†Ø© Ù…Ù† Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡...", scope_en: "Review sample POs...", objective_ar: "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„", objective_en: "Verify Compliance", owner_ar: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©", owner_en: "Finance", progress: 55 },
          { id: "M-2025-003", title_ar: "ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ", title_en: "Cybersecurity Audit", dept_ar: "Ø§Ù„ØªÙ‚Ù†ÙŠØ©", dept_en: "Tech", status: "done", due: "2025-10-30", scope_ar: "ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...", scope_en: "Access review...", objective_ar: "ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", objective_en: "Secure Data", owner_ar: "ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", owner_en: "IT", progress: 100 }
        ],
        findings: [
          { id: "F-2025-01", ref: "F-2025-01", desc_ar: "Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©.", desc_en: "Fixed asset mismatch.", risk: "high", owner_ar: "Ø§Ù„Ù…Ø§Ù„ÙŠØ©", owner_en: "Finance", state: "open", relatedMissionId: "M-2025-001", due: "2025-12-05", createdAt: "2025-10-15" }
        ],
        profile: {
          employeeId: "2020",
          name_ar: "Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
          name_en: "Ali Abdullah Alghamdi",
          role_ar: "Ù…Ø±Ø§Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ Ø£ÙˆÙ„",
          role_en: "Senior Internal Auditor",
          leaveBalance: 22,
          commitment: 99,
          attendance: [
            { date_ar: "Ø§Ù„Ø£Ø­Ø¯ØŒ 12 Ø£ÙƒØªÙˆØ¨Ø±", date_en: "Sun, 12 Oct", in_ar: "07:45 Øµ", out_ar: "04:00 Ù…", in_en: "07:45 AM", out_en: "04:00 PM", status_ar: "Ù…ÙƒØªÙ…Ù„", status_en: "Complete" },
            { date_ar: "Ø§Ù„Ø®Ù…ÙŠØ³ØŒ 09 Ø£ÙƒØªÙˆØ¨Ø±", date_en: "Thu, 09 Oct", in_ar: "07:50 Øµ", out_ar: "04:10 Ù…", in_en: "07:50 AM", out_en: "04:10 PM", status_ar: "Ù…ÙƒØªÙ…Ù„", status_en: "Complete" }
          ],
          lastCheck: null
        }
      };
    }

    function getStore() {
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) {
        const seeded = seedStore();
        localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
        return seeded;
      }
      try { return JSON.parse(raw); } catch {
        const seeded = seedStore();
        localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
        return seeded;
      }
    }

    function setStore(next) { localStorage.setItem(STORE_KEY, JSON.stringify(next)); }
    function updateStore(mutator) { const s = getStore(); const next = mutator(structuredClone(s)) || s; setStore(next); return next; }
    function t(key) { return translations[currentLang][key] || key; }
    function isDark() { return document.documentElement.classList.contains('dark'); }
    function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Badges Helpers
    function statusBadge(status) {
      const map = { planned: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200', ongoing: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200', done: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200' };
      const label = { planned: t('status_planned'), ongoing: t('status_ongoing'), done: t('status_done') }[status] || status;
      return `<span class="px-2 py-1 rounded text-xs font-bold ${map[status] || 'bg-slate-100'}">${label}</span>`;
    }
    function riskBadge(risk) {
      const map = { low: 'text-green-600', med: 'text-yellow-500', high: 'text-red-500' };
      const label = { low: t('risk_low'), med: t('risk_med'), high: t('risk_high') }[risk] || risk;
      return `<span class="${map[risk] || ''} font-bold text-xs">${label}</span>`;
    }
    function stateBadge(state) {
      const map = { open: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-200', progress: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-200', closed: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200' };
      const label = { open: t('state_open'), progress: t('state_progress'), closed: t('state_closed') }[state] || state;
      return `<span class="px-2 py-1 rounded text-xs font-bold ${map[state] || 'bg-slate-100'}">${label}</span>`;
    }

    // Toast
    function toast(message, type='info') {
      const wrap = document.getElementById('toastContainer');
      wrap.style[currentLang === 'ar' ? 'right' : 'left'] = 'auto';
      wrap.style[currentLang === 'ar' ? 'left' : 'right'] = '24px';
      
      const colors = { info: 'border-slate-200 dark:border-slate-700', success: 'border-green-200 dark:border-green-900/40', danger: 'border-red-200 dark:border-red-900/40' };
      const icon = { info: 'fa-circle-info', success: 'fa-circle-check', danger: 'fa-circle-xmark' }[type] || 'fa-circle-info';
      
      const el = document.createElement('div');
      el.className = `fade-in bg-white dark:bg-slate-800 border ${colors[type]} shadow-xl rounded-xl px-4 py-3 flex items-start gap-3 max-w-xs md:max-w-sm pointer-events-auto`;
      el.innerHTML = `<i class="fa-solid ${icon} text-brandRed mt-0.5"></i><div class="text-sm text-slate-700 dark:text-slate-200">${escapeHtml(message)}</div>`;
      wrap.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; }, 2600);
      setTimeout(() => el.remove(), 3000);
    }

    // Modal
    function openModal(title, bodyHTML, footerHTML) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalBody').innerHTML = bodyHTML;
      document.getElementById('modalFooter').innerHTML = footerHTML || '';
      document.getElementById('modalOverlay').classList.add('active');
      document.getElementById('modal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.getElementById('modal').classList.remove('active');
    }

    // Core Logic
    function renderView(view) {
      currentView = view;
      document.querySelectorAll('.nav-item').forEach(el => {
        el.className = `w-full flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-brandRed rounded-xl transition nav-item`;
      });
      const active = document.getElementById('nav-' + view);
      if (active) active.className = `w-full flex items-center gap-3 px-3 py-2.5 bg-brandRed text-white rounded-xl shadow-lg shadow-red-500/20 font-bold transition nav-item`;

      const pageTitle = document.getElementById('pageTitle');
      const content = document.getElementById('mainContent');

      if (view === 'dashboard') { pageTitle.innerText = t('overview'); content.innerHTML = dashboardHTML(); setTimeout(initChart, 40); }
      else if (view === 'missions') { pageTitle.innerText = t('missions'); content.innerHTML = missionsHTML(); setTimeout(renderMissionsTable, 0); }
      else if (view === 'findings') { pageTitle.innerText = t('findings'); content.innerHTML = findingsHTML(); setTimeout(renderFindingsTable, 0); }
      else if (view === 'reports') { pageTitle.innerText = t('reports'); content.innerHTML = reportsHTML(); }
      else if (view === 'profile') { pageTitle.innerText = t('profile_hr'); content.innerHTML = profileHTML(); }

      if (window.innerWidth < 768) {
        const sb = document.getElementById('sidebar');
        if (sb.classList.contains('open')) toggleSidebar();
      }
    }

    // --- HTML Generators (Dashboard) ---
    function dashboardHTML() {
      const s = getStore();
      const openFindings = s.findings.filter(f => f.state !== 'closed').length;
      const completed = s.missions.filter(m => m.status === 'done').length;
      const total = Math.max(1, s.missions.length);
      const progress = Math.round((completed / total) * 100);

      return `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
          ${statCard(t('plan_progress'), progress + '%', 'green')}
          ${statCard(t('open_findings'), String(openFindings), 'red')}
          ${statCard(t('urgent_actions'), '1', 'orange')}
          ${statCard(t('audit_coverage'), '85%', 'blue')}
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
          <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-chart-pie text-brandRed"></i> ${t('audit_status')}</h3>
            </div>
            <div class="relative h-64 w-full"><canvas id="auditChartCanvas"></canvas></div>
          </div>
          <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
            <h3 class="font-bold text-slate-800 dark:text-white mb-4">${t('quick_actions')}</h3>
            <div class="space-y-3">
              ${quickActionBtn(t('new_mission'), 'fa-plus', "openNewMission()")}
              ${quickActionBtn(t('add_finding'), 'fa-pen-to-square', "openNewFinding()")}
              ${quickActionBtn(t('generate_report'), 'fa-file-lines', "renderView('reports')")}
            </div>
          </div>
        </div>`;
    }

    function statCard(label, value, tint) {
      const colors = { green: 'text-green-600 bg-green-50 dark:bg-green-900/20', red: 'text-red-500 bg-red-50 dark:bg-red-900/20', orange: 'text-orange-500 bg-orange-50 dark:bg-orange-900/20', blue: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20' };
      const c = colors[tint] || colors.green;
      return `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden">
        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold mb-1">${escapeHtml(label)}</p>
        <h3 class="text-3xl font-extrabold ${c.split(' ')[0]}">${escapeHtml(value)}</h3>
      </div>`;
    }

    function quickActionBtn(label, icon, action) {
      return `<button class="w-full text-start p-3 bg-slate-50 dark:bg-slate-700/50 hover:bg-red-50 dark:hover:bg-slate-700 rounded-lg transition group flex items-center gap-3" onclick="${action}">
        <div class="w-8 h-8 rounded-lg bg-white dark:bg-slate-600 flex items-center justify-center text-slate-400 group-hover:text-brandRed"><i class="fa-solid ${icon}"></i></div>
        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 group-hover:text-brandRed">${escapeHtml(label)}</span>
      </button>`;
    }

    // --- HTML Generators (Missions & Findings Tables) ---
    function missionsHTML() {
      return `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in">
          <div class="flex justify-between items-center mb-5">
            <h3 class="font-bold text-lg text-slate-800 dark:text-white">${t('audit_missions')}</h3>
            <button class="bg-brandRed text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-red-600 transition" onclick="openNewMission()"><i class="fa-solid fa-plus"></i> ${t('new_mission')}</button>
          </div>
          <div class="overflow-x-auto"><table class="w-full text-start text-sm text-slate-600 dark:text-slate-300">
            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase"><tr><th class="p-4">${t('col_mission')}</th><th class="p-4">${t('col_dept')}</th><th class="p-4">${t('col_status')}</th><th class="p-4">${t('col_due')}</th></tr></thead>
            <tbody id="missionsTbody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
          </table></div>
        </div>`;
    }

    function renderMissionsTable() {
      const s = getStore();
      const tbody = document.getElementById('missionsTbody');
      if (!tbody) return;
      tbody.innerHTML = s.missions.map(m => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
          <td class="p-4"><div class="font-bold text-slate-800 dark:text-white">${escapeHtml(currentLang==='ar'?m.title_ar:m.title_en)}</div><div class="text-[11px] text-slate-400 font-mono mt-1">${m.id}</div></td>
          <td class="p-4">${escapeHtml(currentLang==='ar'?m.dept_ar:m.dept_en)}</td>
          <td class="p-4">${statusBadge(m.status)}</td>
          <td class="p-4">${m.due}</td>
        </tr>`).join('');
    }

    function findingsHTML() {
      return `
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in">
          <div class="flex justify-between items-center mb-5">
            <h3 class="font-bold text-lg text-slate-800 dark:text-white">${t('findings_log')}</h3>
            <button class="bg-brandRed text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-red-600 transition" onclick="openNewFinding()"><i class="fa-solid fa-plus"></i> ${t('add_finding')}</button>
          </div>
          <div class="overflow-x-auto"><table class="w-full text-start text-sm text-slate-600 dark:text-slate-300">
            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase"><tr><th class="p-4">${t('col_ref')}</th><th class="p-4">${t('col_desc')}</th><th class="p-4">${t('col_risk')}</th><th class="p-4">${t('col_state')}</th></tr></thead>
            <tbody id="findingsTbody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
          </table></div>
        </div>`;
    }

    function renderFindingsTable() {
      const s = getStore();
      const tbody = document.getElementById('findingsTbody');
      if (!tbody) return;
      tbody.innerHTML = s.findings.map(f => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
          <td class="p-4 font-mono text-xs">${f.ref}</td>
          <td class="p-4 font-bold text-slate-800 dark:text-white">${escapeHtml(currentLang==='ar'?f.desc_ar:f.desc_en)}</td>
          <td class="p-4">${riskBadge(f.risk)}</td>
          <td class="p-4">${stateBadge(f.state)}</td>
        </tr>`).join('');
    }

    // --- Reports & Profile Placeholders ---
    function reportsHTML() {
      return `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in text-center py-20"><i class="fa-solid fa-file-pdf text-4xl text-slate-300 mb-4"></i><p class="text-slate-500">${currentLang==='ar'?'ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (ØªØ¬Ø±ÙŠØ¨ÙŠØ©)':'Reports Page (Demo)'}</p></div>`;
    }
    function profileHTML() {
      return `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 fade-in text-center py-20"><i class="fa-solid fa-id-badge text-4xl text-slate-300 mb-4"></i><p class="text-slate-500">${currentLang==='ar'?'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)':'Profile Page (Demo)'}</p></div>`;
    }

    // --- Functions ---
    function initChart() {
      const canvas = document.getElementById('auditChartCanvas');
      if (!canvas) return;
      if (auditChart) auditChart.destroy();
      
      const s = getStore();
      const done = s.missions.filter(m => m.status === 'done').length;
      const ongoing = s.missions.filter(m => m.status === 'ongoing').length;
      const planned = s.missions.filter(m => m.status === 'planned').length;

      auditChart = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: [t('completed'), t('in_progress'), t('planned')],
          datasets: [{ data: [done, ongoing, planned], backgroundColor: ['#10B981', '#3B82F6', '#FB4747'], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: isDark()?'#E2E8F0':'#334155', font: {family:'Inter'} } } }, cutout: '75%' }
      });
    }

    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const ov = document.getElementById('mobileOverlay');
      sb.classList.toggle('open');
      ov.classList.toggle('active');
    }

    function toggleNotifications() { document.getElementById('notifDropdown').classList.toggle('hidden'); }
    
    function toggleAI(open) {
      const ai = document.getElementById('aiSidebar');
      if (currentLang === 'ar') ai.style.transform = open ? 'translateX(0)' : 'translateX(120%)';
      else ai.style.transform = open ? 'translateX(0)' : 'translateX(120%)';
    }

    function toggleLanguage() {
      currentLang = (currentLang === 'ar') ? 'en' : 'ar';
      localStorage.setItem('lang', currentLang);
      location.reload();
    }

    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark() ? 'dark' : 'light');
      document.getElementById('themeIcon').className = isDark() ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      if(currentView === 'dashboard') setTimeout(initChart, 50);
    }

    // --- Init ---
    (function initApp() {
      // Apply Theme
      const th = localStorage.getItem('theme') || 'light';
      if (th === 'dark') document.documentElement.classList.add('dark');
      document.getElementById('themeIcon').className = isDark() ? 'fa-solid fa-sun' : 'fa-solid fa-moon';

      // Apply Lang
