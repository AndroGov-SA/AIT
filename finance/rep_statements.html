<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statements | AndroGov</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brandRed: '#FB4747', 
                        brandDark: '#0F172A',
                        moneyGreen: '#10B981',
                        moneyRed: '#EF4444'
                    },
                    fontFamily: { sans: ['Tajawal', 'Inter', 'sans-serif'], en: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .num-font { font-family: 'Inter', sans-serif; font-feature-settings: "tnum"; }
        /* A4 Paper Effect */
        .a4-paper {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            min-height: 800px;
            padding: 40px;
            position: relative;
        }
        .dark .a4-paper { background: #1e293b; color: white; border: 1px solid #334155; }
        
        @media print {
            body * { visibility: hidden; }
            #reportContainer, #reportContainer * { visibility: visible; }
            #reportContainer { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300 opacity-0">

    <div id="sidebar-container" class="no-print"></div>
    
    <div class="main-content-wrapper md:mr-72 transition-all duration-300 flex flex-col min-h-screen">
        <div id="header-container" class="no-print"></div>

        <main class="p-6 space-y-6">
            
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 no-print">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 dark:text-white" data-i18n="pageTitle">القوائم المالية</h1>
                    <p class="text-sm text-slate-500 mt-1" data-i18n="pageSub">المركز المالي، الدخل، والتدفقات النقدية</p>
                </div>
                
                <div class="flex flex-wrap gap-3 items-center bg-white dark:bg-slate-800 p-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <div class="flex items-center gap-2 px-2">
                        <span class="text-xs font-bold text-slate-400" data-i18n="lblPeriod">الفترة:</span>
                        <select id="periodSelector" onchange="refreshReport()" class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg py-1.5 px-3 text-xs font-bold outline-none dark:text-white">
                            <option value="q1">Q1 - 2026 (Current)</option>
                            <option value="2025">FY - 2025 (Audited)</option>
                        </select>
                    </div>
                    
                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-600"></div>

                    <button onclick="window.print()" class="px-4 py-2 text-slate-500 hover:text-slate-700 dark:text-slate-300 transition text-xs font-bold flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> <span data-i18n="btnPrint">طباعة</span>
                    </button>
                    <button onclick="approveReport()" id="btnApprove" class="px-4 py-2 bg-brandRed text-white rounded-lg text-xs font-bold shadow-lg shadow-red-500/30 hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-file-signature"></i> <span data-i18n="btnSign">اعتماد وتوقيع (CFO)</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-center no-print">
                <div class="flex bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <button onclick="switchReport('bs')" id="tab-bs" class="px-6 py-2 rounded-lg text-sm font-bold bg-brandRed text-white shadow-md transition-all">
                        <span data-i18n="tabBS">المركز المالي</span>
                    </button>
                    <button onclick="switchReport('pl')" id="tab-pl" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-all">
                        <span data-i18n="tabPL">قائمة الدخل</span>
                    </button>
                    <button onclick="switchReport('cf')" id="tab-cf" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-all">
                        <span data-i18n="tabCF">التدفقات النقدية</span>
                    </button>
                </div>
            </div>

            <div id="reportContainer" class="a4-paper rounded-none md:rounded-xl mx-auto max-w-5xl transition-all">
                
                <div class="border-b-2 border-slate-800 dark:border-slate-400 pb-6 mb-8 flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <img src="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" class="w-16 h-16 rounded-xl bg-slate-50 p-1 border">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white" data-i18n="coName">شركة أندروميدا لتقنية المعلومات</h2>
                            <p class="text-sm text-slate-500 uppercase tracking-wide font-bold mt-1" id="reportTitle">قائمة المركز المالي (الميزانية العمومية)</p>
                            <p class="text-xs text-slate-400 mt-1"><span data-i18n="repDate">كما في:</span> <span id="reportDate" class="font-mono text-slate-600 dark:text-slate-300 font-bold">31 مارس 2026</span></p>
                        </div>
                    </div>
                    <div class="text-left rtl:text-left ltr:text-right">
                        <div id="statusBadge" class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 border border-yellow-200 rounded text-xs font-bold uppercase mb-2">
                            <i class="fa-solid fa-pen-ruler"></i> <span data-i18n="stDraft">مسودة (غير معتمد)</span>
                        </div>
                        <p class="text-[10px] text-slate-400">Currency: <span class="font-bold">SAR</span></p>
                    </div>
                </div>

                <div class="overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 dark:bg-slate-800 border-y border-slate-200 dark:border-slate-600 text-slate-500">
                            <tr>
                                <th class="py-3 text-right rtl:text-right ltr:text-left px-4" data-i18n="colDesc">البيان</th>
                                <th class="py-3 text-right font-mono px-4" data-i18n="colCurrent">مارس 2026</th>
                                <th class="py-3 text-right font-mono px-4 text-slate-400" data-i18n="colPrev">ديسمبر 2025</th>
                                <th class="py-3 text-center px-4" data-i18n="colChange">التغير</th>
                            </tr>
                        </thead>
                        <tbody id="reportRows" class="divide-y divide-slate-100 dark:divide-slate-700/50">
                            </tbody>
                    </table>
                </div>

                <div class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-700 flex justify-between items-end">
                    <div class="text-center w-48">
                        <p class="text-xs font-bold text-slate-400 mb-12" data-i18n="signAcc">المحاسب العام</p>
                        <div class="border-t border-slate-300 dark:border-slate-600 pt-2">
                            <p class="text-sm font-bold">خالد العتيبي</p>
                        </div>
                    </div>
                    
                    <div class="text-center w-48 relative">
                        <div id="digitalStamp" class="hidden absolute -top-10 left-1/2 -translate-x-1/2 w-32 h-32 border-4 border-brandRed rounded-full flex items-center justify-center opacity-80 -rotate-12 animate-pulse">
                            <div class="text-center">
                                <p class="text-brandRed font-bold text-[10px] uppercase">Andromeda IT</p>
                                <p class="text-brandRed font-black text-lg uppercase">APPROVED</p>
                                <p class="text-brandRed text-[9px]" id="stampDate">2026-04-05</p>
                            </div>
                        </div>

                        <p class="text-xs font-bold text-slate-400 mb-12" data-i18n="signCFO">المدير المالي (CFO)</p>
                        <div class="border-t border-slate-300 dark:border-slate-600 pt-2">
                            <p class="text-sm font-bold">محمد البخيتي</p>
                        </div>
                    </div>

                    <div class="text-center w-48">
                        <p class="text-xs font-bold text-slate-400 mb-12" data-i18n="signCEO">الرئيس التنفيذي</p>
                        <div class="border-t border-slate-300 dark:border-slate-600 pt-2">
                            <p class="text-sm font-bold">هشام السحيباني</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center text-[10px] text-slate-300">
                    <p>Generated by AndroGov ERP System | ID: RPT-2026-00451</p>
                </div>

            </div>

        </main>
    </div>

    <script src="js/core/config.js"></script>
    <script src="js/core/i18n.js"></script>
    <script src="js/services/data-service.js"></script>
    <script src="js/components/role-switcher.js"></script>
    <script src="js/components/layout.js"></script>
    <script src="js/components/bot.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const checkLibs = setInterval(() => {
            // ننتظر تحميل المحرك والكونفيج
            if (typeof Layout !== 'undefined' && typeof AppConfig !== 'undefined') {
                clearInterval(checkLibs);

                const boardUser = {
                    id: 'USR_002',
                    role: 'CFO', // ✅ متطابق مع _menuDefinitions في layout.js
                    displayName: 'المدير المالي',
                    displayTitle: 'المدير المالي',
                    avatar: 'https://ui-avatars.com/api/?name=CFO&background=FB4747&color=fff'
                };

                // 1. المزامنة مع AppConfig (الخاص بك)
                AppConfig.setCurrentUser(boardUser);

                // 2. المزامنة اليدوية مع localStorage لضمان استجابة المحرك v10.5
                localStorage.setItem('currentUser', JSON.stringify(boardUser));
                localStorage.setItem('activeRole', 'CFO');

                // 3. تشغيل المحرك
                Layout.init();
                
                // 4. إظهار الصفحة
                document.body.classList.remove('opacity-0');
                console.log("✅ Finance Sidebar Activated with Role: CFO");
            }
        }, 50);
    });
</script>

    <script>
        // --- Mock Data for Reports ---
        const reportData = {
            bs: [ // Balance Sheet
                { type: "header", titleAr: "الأصول (Assets)", titleEn: "Assets" },
                { type: "row", titleAr: "النقدية وما في حكمها", titleEn: "Cash & Equivalents", curr: 2450000, prev: 2100000 },
                { type: "row", titleAr: "العملاء والذمم المدينة", titleEn: "Accounts Receivable", curr: 850000, prev: 920000 },
                { type: "row", titleAr: "المخزون", titleEn: "Inventory", curr: 320000, prev: 280000 },
                { type: "total", titleAr: "إجمالي الأصول المتداولة", titleEn: "Total Current Assets", curr: 3620000, prev: 3300000 },
                
                { type: "spacer" },
                
                { type: "row", titleAr: "الممتلكات والمعدات (بالصافي)", titleEn: "Property & Equipment (Net)", curr: 1250000, prev: 1100000 },
                { type: "total", titleAr: "إجمالي الأصول غير المتداولة", titleEn: "Total Non-Current Assets", curr: 1250000, prev: 1100000 },
                
                { type: "grand", titleAr: "إجمالي الأصول", titleEn: "Total Assets", curr: 4870000, prev: 4400000 },

                { type: "header", titleAr: "الخصوم وحقوق الملكية", titleEn: "Liabilities & Equity" },
                { type: "row", titleAr: "الموردين والذمم الدائنة", titleEn: "Accounts Payable", curr: 425000, prev: 380000 },
                { type: "row", titleAr: "ضريبة القيمة المضافة", titleEn: "VAT Payable", curr: 150000, prev: 120000 },
                { type: "total", titleAr: "إجمالي الخصوم", titleEn: "Total Liabilities", curr: 575000, prev: 500000 },
                
                { type: "row", titleAr: "رأس المال", titleEn: "Share Capital", curr: 3000000, prev: 3000000 },
                { type: "row", titleAr: "الأرباح المبقاة", titleEn: "Retained Earnings", curr: 1295000, prev: 900000 },
                { type: "total", titleAr: "إجمالي حقوق الملكية", titleEn: "Total Equity", curr: 4295000, prev: 3900000 },

                { type: "grand", titleAr: "إجمالي الخصوم وحقوق الملكية", titleEn: "Total Liab. & Equity", curr: 4870000, prev: 4400000 }
            ],
            pl: [ // Profit & Loss
                { type: "header", titleAr: "الإيرادات", titleEn: "Revenue" },
                { type: "row", titleAr: "إيرادات المشاريع", titleEn: "Projects Revenue", curr: 1500000, prev: 1200000 },
                { type: "row", titleAr: "تكلفة المبيعات", titleEn: "Cost of Sales", curr: -450000, prev: -380000 },
                { type: "total", titleAr: "مجمل الربح", titleEn: "Gross Profit", curr: 1050000, prev: 820000 },

                { type: "header", titleAr: "المصروفات التشغيلية", titleEn: "Operating Expenses" },
                { type: "row", titleAr: "الرواتب والأجور", titleEn: "Salaries & Wages", curr: -320000, prev: -300000 },
                { type: "row", titleAr: "مصاريف إدارية وعمومية", titleEn: "G&A Expenses", curr: -85000, prev: -80000 },
                { type: "row", titleAr: "الإهلاك", titleEn: "Depreciation", curr: -25000, prev: -25000 },
                
                { type: "grand", titleAr: "صافي الربح (قبل الزكاة)", titleEn: "Net Income (Before Zakat)", curr: 620000, prev: 415000 }
            ],
            cf: [ // Cash Flow
                 { type: "header", titleAr: "الأنشطة التشغيلية", titleEn: "Operating Activities" },
                 { type: "row", titleAr: "صافي الربح", titleEn: "Net Income", curr: 620000, prev: 415000 },
                 { type: "row", titleAr: "تعديل: الإهلاك", titleEn: "Adj: Depreciation", curr: 25000, prev: 25000 },
                 { type: "row", titleAr: "التغير في العملاء", titleEn: "Change in AR", curr: 70000, prev: -50000 },
                 { type: "total", titleAr: "صافي النقد من التشغيل", titleEn: "Net Cash from Ops", curr: 715000, prev: 390000 },

                 { type: "header", titleAr: "الأنشطة الاستثمارية", titleEn: "Investing Activities" },
                 { type: "row", titleAr: "شراء أصول ثابتة", titleEn: "Purchase of PPE", curr: -150000, prev: -50000 },
                 
                 { type: "grand", titleAr: "صافي التغير في النقد", titleEn: "Net Change in Cash", curr: 565000, prev: 340000 }
            ]
        };

        const translations = {
            ar: {
                pageTitle: "القوائم المالية", pageSub: "المركز المالي، الدخل، والتدفقات النقدية",
                lblPeriod: "الفترة:", btnPrint: "طباعة", btnSign: "اعتماد وتوقيع (CFO)",
                tabBS: "المركز المالي", tabPL: "قائمة الدخل", tabCF: "التدفقات النقدية",
                coName: "شركة أندروميدا لتقنية المعلومات", repDate: "كما في:",
                stDraft: "مسودة (غير معتمد)", stApproved: "معتمد نهائياً",
                colDesc: "البيان", colCurrent: "مارس 2026", colPrev: "ديسمبر 2025", colChange: "التغير",
                signAcc: "المحاسب العام", signCFO: "المدير المالي (CFO)", signCEO: "الرئيس التنفيذي",
                msgSigned: "تم اعتماد القائمة المالية وتوقيعها رقمياً بنجاح.",
                titleBS: "قائمة المركز المالي (الميزانية العمومية)",
                titlePL: "قائمة الدخل (الأرباح والخسائر)",
                titleCF: "قائمة التدفقات النقدية"
            },
            en: {
                pageTitle: "Financial Statements", pageSub: "Balance Sheet, P&L, Cash Flow",
                lblPeriod: "Period:", btnPrint: "Print", btnSign: "Approve & Sign",
                tabBS: "Balance Sheet", tabPL: "Income Statement", tabCF: "Cash Flow",
                coName: "Andromeda Information Technology", repDate: "As of:",
                stDraft: "Draft (Unapproved)", stApproved: "Final Approved",
                colDesc: "Description", colCurrent: "Mar 2026", colPrev: "Dec 2025", colChange: "Change",
                signAcc: "General Accountant", signCFO: "Chief Financial Officer", signCEO: "Chief Executive Officer",
                msgSigned: "Statement approved and digitally signed successfully.",
                titleBS: "Statement of Financial Position (Balance Sheet)",
                titlePL: "Statement of Income (Profit & Loss)",
                titleCF: "Statement of Cash Flows"
            }
        };

        let currentReport = 'bs';

        document.addEventListener('DOMContentLoaded', () => {
            applyLanguage();
            renderReport('bs');
            window.addEventListener('storage', (e) => { if (e.key === 'lang') location.reload(); });
        });

        function applyLanguage() {
            const lang = localStorage.getItem('lang') || 'ar';
            const dict = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) el.innerText = dict[key];
            });
        }

        // --- Core Logic ---
        window.switchReport = function(type) {
            currentReport = type;
            const lang = localStorage.getItem('lang') || 'ar';
            
            // Update Tabs
            const tabs = ['bs', 'pl', 'cf'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === type) {
                    btn.className = "px-6 py-2 rounded-lg text-sm font-bold bg-brandRed text-white shadow-md transition-all";
                } else {
                    btn.className = "px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-all";
                }
            });

            // Update Title
            const titles = {
                bs: translations[lang].titleBS,
                pl: translations[lang].titlePL,
                cf: translations[lang].titleCF
            };
            document.getElementById('reportTitle').innerText = titles[type];

            renderReport(type);
        };

        function renderReport(type) {
            const lang = localStorage.getItem('lang') || 'ar';
            const data = reportData[type];
            const tbody = document.getElementById('reportRows');
            tbody.innerHTML = '';

            data.forEach(row => {
                if (row.type === 'spacer') {
                    tbody.innerHTML += `<tr><td colspan="4" class="py-4"></td></tr>`;
                    return;
                }

                if (row.type === 'header') {
                    tbody.innerHTML += `
                    <tr>
                        <td colspan="4" class="py-3 px-4 font-bold text-brandRed uppercase tracking-wider text-xs bg-slate-50 dark:bg-slate-800/50 mt-4">
                            ${lang==='ar' ? row.titleAr : row.titleEn}
                        </td>
                    </tr>`;
                    return;
                }

                // Calculation for Change
                const change = row.curr - row.prev;
                const pct = row.prev !== 0 ? ((change / Math.abs(row.prev)) * 100).toFixed(1) : 0;
                let changeHtml = '';
                
                if (change > 0) changeHtml = `<span class="text-moneyGreen font-bold text-xs">+${pct}% <i class="fa-solid fa-arrow-up text-[9px]"></i></span>`;
                else if (change < 0) changeHtml = `<span class="text-moneyRed font-bold text-xs">${pct}% <i class="fa-solid fa-arrow-down text-[9px]"></i></span>`;
                else changeHtml = `<span class="text-slate-400">-</span>`;

                // Styling based on row type
                let rowClass = "hover:bg-slate-50 dark:hover:bg-slate-800/30";
                let fontClass = "text-slate-700 dark:text-slate-300";
                let borderClass = "";

                if (row.type === 'total') {
                    rowClass = "bg-slate-50 dark:bg-slate-800 font-bold";
                    fontClass = "text-slate-900 dark:text-white";
                    borderClass = "border-t border-slate-300 dark:border-slate-600";
                } else if (row.type === 'grand') {
                    rowClass = "bg-slate-100 dark:bg-slate-700 font-bold text-lg";
                    fontClass = "text-brandRed";
                    borderClass = "border-y-2 border-slate-400 dark:border-slate-500";
                }

                const html = `
                <tr class="${rowClass} ${borderClass}">
                    <td class="py-3 px-4 ${fontClass} ${row.type==='row'?'pl-8 rtl:pr-8 rtl:pl-0':''}">${lang==='ar' ? row.titleAr : row.titleEn}</td>
                    <td class="py-3 px-4 text-right font-mono ${fontClass}">${row.curr.toLocaleString()}</td>
                    <td class="py-3 px-4 text-right font-mono text-slate-500">${row.prev.toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">${changeHtml}</td>
                </tr>`;
                tbody.innerHTML += html;
            });
        }

        // --- CFO Signature Logic ---
        window.approveReport = function() {
            const lang = localStorage.getItem('lang') || 'ar';
            const t = translations[lang];
            const btn = document.getElementById('btnApprove');
            const badge = document.getElementById('statusBadge');
            const stamp = document.getElementById('digitalStamp');

            if(confirm(lang==='ar' ? 'هل أنت متأكد من اعتماد هذه القوائم؟ لا يمكن التراجع.' : 'Confirm approval? This cannot be undone.')) {
                
                // 1. Change Status Badge
                badge.className = "inline-block px-3 py-1 bg-green-100 text-green-700 border border-green-200 rounded text-xs font-bold uppercase mb-2";
                badge.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${t.stApproved}`;

                // 2. Show Digital Stamp
                stamp.classList.remove('hidden');
                document.getElementById('stampDate').innerText = new Date().toISOString().split('T')[0];

                // 3. Disable Button
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = `<i class="fa-solid fa-lock"></i> ${lang==='ar'?'تم الاعتماد':'Signed'}`;

                alert(t.msgSigned);
            }
        }

    </script>
</body>
</html>
