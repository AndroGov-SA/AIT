<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FB4747">
  <title>AndroGov | بوابة الدخول الموحدة</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { brandDark: '#1E293B', brandBlue: '#4267B2', brandRed: '#FB4747' }, fontFamily: { sans: ['Tajawal', 'Inter', 'sans-serif'] } } }
    }
  </script>
  <style>
    .users-scroll::-webkit-scrollbar { width: 4px; }
    .users-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    .dark .users-scroll::-webkit-scrollbar-thumb { background-color: #475569; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-white min-h-screen flex flex-col lg:flex-row font-sans transition-colors duration-300">

  <aside class="hidden lg:flex w-1/2 bg-slate-900 relative flex-col justify-between p-12 text-white overflow-hidden h-screen sticky top-0">
    <div class="absolute inset-0 bg-gradient-to-br from-brandBlue/35 to-slate-900/95"></div>
    <div class="relative flex flex-col h-full justify-center">
      <div class="flex items-center gap-5 mb-8">
        <img src="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" class="w-24 h-24 rounded-3xl bg-white p-2 shadow-2xl object-contain">
        <div>
          <h1 class="text-5xl font-extrabold">AndroGov</h1>
          <p class="text-slate-300 mt-2 text-lg font-light">منصة الحوكمة الرقمية الشاملة</p>
        </div>
      </div>
      </div>
  </aside>

  <main class="w-full lg:w-1/2 flex flex-col relative bg-slate-50 dark:bg-slate-900 transition-colors duration-300 min-h-screen">
    <header class="w-full flex justify-between items-center gap-3 p-6">
        <a href="index.html" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-brandBlue transition-colors group">
            <i class="fa-solid fa-arrow-right group-hover:-translate-x-1 transition-transform"></i> العودة
        </a>
        <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full border border-slate-200 dark:border-slate-700 flex items-center justify-center">
            <i id="themeIcon" class="fa-solid fa-moon"></i>
        </button>
    </header>

    <section class="flex-1 flex flex-col justify-center items-center w-full px-6 py-4">
      <div class="w-full max-w-xl">
        <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur p-8 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-xl">
          
          <div class="text-center mb-6">
            <h2 class="text-2xl font-extrabold text-slate-800 dark:text-white">تسجيل الدخول</h2>
            <p class="text-slate-500 text-xs mt-1">يتم جلب البيانات الحية من المستودع المركزي</p>
          </div>

          <form id="loginForm" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1.5">البريد الإلكتروني</label>
              <input type="email" id="email" class="w-full py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 focus:ring-2 focus:ring-brandRed transition-all dark:text-white text-sm" required>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1.5">كلمة المرور</label>
              <input type="password" id="password" class="w-full py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 focus:ring-2 focus:ring-brandRed transition-all dark:text-white text-sm" required>
            </div>
            <button type="submit" class="w-full bg-brandRed hover:bg-red-700 text-white font-bold py-2.5 rounded-xl transition-all shadow-lg text-sm">دخول آمن</button>
          </form>

          <div class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
            <p class="text-[9px] text-center text-slate-400 uppercase tracking-widest mb-4">اختر حساباً (يتم التحميل من data/company_policy.json)</p>
            
            <div id="usersContainer" class="max-h-[300px] overflow-y-auto users-scroll space-y-4 pr-1">
               <div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-brandRed"></i> جاري تحميل المستخدمين...</div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <script src="js/auth.js"></script>

  <script>
    // تهيئة الصفحة وتشغيل المحرك
    document.addEventListener('DOMContentLoaded', async () => {
        // تهيئة الثيم
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        // 1. تشغيل محرك المصادقة
        await window.authSystem.init();
        
        // 2. جلب المستخدمين وعرضهم
        const users = await window.authSystem.getDemoUsers();
        renderDynamicUsers(users);

        // 3. ربط النموذج
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            try {
                const redirect = await window.authSystem.login(email, pass);
                window.location.href = redirect;
            } catch (err) {
                alert(err.message);
            }
        });
    });

    // دالة الرسم (تأخذ البيانات من المحرك وترسمها)
    function renderDynamicUsers(users) {
        const container = document.getElementById('usersContainer');
        container.innerHTML = ''; // مسح التحميل

        // تقسيم المستخدمين حسب النوع (Type) الذي حدده auth.js
        const groups = {
            'admin': { title: 'إدارة النظام', color: 'text-red-600', icon: 'fa-user-shield' },
            'board': { title: 'مجلس الإدارة', color: 'text-brandBlue', icon: 'fa-building-columns' },
            'shareholder': { title: 'المساهمين', color: 'text-green-600', icon: 'fa-hand-holding-dollar' },
            'exec': { title: 'الإدارة التنفيذية', color: 'text-purple-600', icon: 'fa-user-tie' },
            'audit': { title: 'التدقيق والامتثال', color: 'text-orange-600', icon: 'fa-scale-balanced' },
            'manager': { title: 'مدراء الإدارات', color: 'text-cyan-600', icon: 'fa-users-gear' },
            'staff': { title: 'الموظفين', color: 'text-slate-500', icon: 'fa-users' }
        };

        // إنشاء الأقسام
        for (const [type, info] of Object.entries(groups)) {
            const groupUsers = users.filter(u => u.type === type);
            if (groupUsers.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h4 class="text-[10px] font-bold ${info.color} mb-2 flex items-center gap-1">
                        <i class="fa-solid ${info.icon}"></i> ${info.title}
                    </h4>
                    <div class="flex flex-wrap gap-2 group-container"></div>
                `;
                
                const btnContainer = section.querySelector('.group-container');
                
                groupUsers.forEach(u => {
                    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=${u.avatarColor}&color=fff&size=64`;
                    btnContainer.innerHTML += `
                        <button type="button" onclick="fillCreds('${u.email}')" class="flex items-center gap-2 px-2 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:border-brandRed transition-all min-w-[140px] text-right">
                            <img src="${avatarUrl}" class="w-6 h-6 rounded-full shrink-0">
                            <div class="overflow-hidden">
                                <p class="text-[9px] font-bold text-slate-700 dark:text-slate-200 truncate w-24">${u.name}</p>
                                <p class="text-[8px] text-slate-400 truncate w-24">${u.title}</p>
                            </div>
                        </button>
                    `;
                });
                
                container.appendChild(section);
            }
        }
    }

    window.fillCreds = (email) => {
        document.getElementById('email').value = email;
        document.getElementById('password').value = '12345678';
    };
    
    window.toggleDarkMode = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    };
  </script>
</body>
</html>
